# RiverWare_Ruleset 9.5.2
# Created 22:49 February 11, 2026
# 
RULESET
NAME "working_ruleset_1";
AGENDA_ORDER ASCENDING;
DESCRIPTION "";
PRECISION   2;
NOTES "";
BEGIN

  POLICY_GROUP   "Generate Output";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "Calculate CumAg_ss_Delv";
    DESCRIPTION          "Calculates cumulative agricultural supply-side deliveries from March 1 to October 31, with reduced scope in November.<br><br>Logic:January 1: Reset cumulative value to 0 acre-ft<br>- March 1: Begin accumulation with current day's flows<br>- March 1 - October 31: Add daily flows to cumulative total<br>- November 1 - November 15: Only include Sta48 and MH from Lost flows<br>- Other dates: Carry forward previous day's value<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" == @"January 1") THEN
            $ "Output.CumAg_ss_DelDV" [] := 0.00000000 "acre-ft";

      ELSE
            $ "Output.CumAg_ss_DelDV" [@"t"] := $ "Output.CumAg_ss_DelDV" [@"t - 1"];

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "Output.CumAg_ss_DelDV" [@"t"] := "FlowToVolume"( $ "A Canal.Diversion Request" [@"t"] + $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] + $ "Ady Canal.DiversionFromUKL_SS" [@"t"] + $ "North Canal.DiversionFromUKL_SS" [@"t"], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" <= @"October 31" )
      ELSEIF_CLAUSE
            $ "Output.CumAg_ss_DelDV" [@"t"] := "FlowToVolume"( $ "A Canal.Diversion Request" [@"t"] + $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] + $ "Ady Canal.DiversionFromUKL_SS" [@"t"] + $ "North Canal.DiversionFromUKL_SS" [@"t"], @"t" ) + $ "Output.CumAg_ss_DelDV" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"November 1" AND @"t" <= @"November 15" )
      ELSEIF_CLAUSE
            $ "Output.CumAg_ss_DelDV" [@"t"] := "FlowToVolume"( $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"], @"t" ) + $ "Output.CumAg_ss_DelDV" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{17dfd2eb-8937-4a41-86ef-4e83cea7c67e}";;

  END
  UUID "{a5700c85-c6dc-4034-90f9-08f1e74b05e6}";;

  POLICY_GROUP   "Flood Control";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "A Canal Flood Control";
    DESCRIPTION          "Manages A Canal diversions during flood conditions, prioritizing DPS usage. <br><br>Logic:<br>- Flood Control Active (Flag = 1): Uses DPS and Project Supply allocation logic<br>- DPS Available: Diverts from DPS first, then Project Supply if needed<br>- DPS Not Available: Uses Project Supply only<br>- No Flood Control: Uses Project Supply only, DPS set to 0";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] != 0.00000000 "acre-ft") THEN
            $ "A Canal.DiversionFromDPS" [] := "Min"( "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ), $ "A Canal.Diversion Request" [@"t"] );

            IF_STATEMENT ($ "A Canal.Diversion Request" [@"t"] > "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" )) THEN
            $ "A Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ) - $ "A Canal.Diversion Request" [@"t"] );

      ELSE
            $ "A Canal.DiversionFromProjectSupply" [@"t"] := $ "A Canal.DiversionFromProjectSupply" [@"t - 1"];

      END_IF_STATEMENT;

      ELSE
            $ "A Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), $ "A Canal.Diversion Request" [@"t"] );

            $ "A Canal.DiversionFromDPS" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{2c72b107-1d65-4ae1-920c-4dc8aa986185}";;

    RULE                 "North Canal UKL Flood Control";
    DESCRIPTION          "Description: <br>This rule determines whether North Canal diversions from Upper Klamath Lake are supplied from the Deferred Project Supply Account (DPS) or from current Project Supply.<br>Logic: <br>If water is available in the Deferred Project Supply Account, it is used first to meet the North Canal diversion. If the diversion demand exceeds the available DPS, the remaining amount is supplied from current Project Supply. If no DPS water is available, the entire diversion is supplied from current Project Supply. In all cases, deliveries cannot exceed the amount available in the respective account.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] != 0.00000000 "acre-ft") THEN
            $ "North Canal.DiversionFromDPS" [] := "Min"( "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ), $ "North Canal.DiversionFromUKL" [@"t"] );

            IF_STATEMENT ($ "North Canal.DiversionFromUKL" [@"t"] > "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" )) THEN
            $ "North Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ) - $ "North Canal.DiversionFromUKL" [@"t"] );

      ELSE
            $ "North Canal.DiversionFromProjectSupply" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "North Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), $ "North Canal.DiversionFromUKL" [@"t"] );

            $ "North Canal.DiversionFromDPS" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{f196bcd7-58d8-407d-bf50-6eb97da96c9a}";;

    RULE                 "North Canal Flood Control";
    DESCRIPTION          "Description: This rule defines how North Canal diversion demand is met during flood control operations, prioritizing LRDC, return flows and pump inflows before diverting from Upper Klamath Lake (UKL).<br>Logic: If the Flood Control Flag is active, diversions are supplied first from LRDC return flow up to the diversion request, then from F/FF pump inflow if additional demand remains, and finally from UKL for any remaining unmet demand. If flood control is not active, no diversion is allocated from LRDC, F/FF, or UKL under this rule.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "North Canal.DiversionFromLRDC" [@"t"] := "Min"( $ "LRDC into Link.Return Flow" [@"t"], $ "North Canal.Diversion Request" [@"t"] );

            IF_STATEMENT ($ "LRDC into Link.Return Flow" [@"t"] < $ "North Canal.Diversion Request" [@"t"]) THEN
            $ "North Canal.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "North Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] );

            IF_STATEMENT ($ "North Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] > $ "F_FF pumps.Inflow" [@"t"]) THEN
            $ "North Canal.DiversionFromUKL" [@"t"] := $ "North Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] - $ "F_FF pumps.Inflow" [@"t"];

      ELSE
            $ "North Canal.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "North Canal.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

            $ "North Canal.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      END_IF_STATEMENT;

    END
    UUID "{ba5e34e8-7266-4ca1-a3cf-b07b6d248191}";;

    RULE                 "Ady Canal UKL Flood Control";
    DESCRIPTION          "Description: Manages Ady Canal diversions from UKL during flood conditions.<br>Logic:<br>If water is available in the Deferred Project Supply Account, it is used first to meet the Ady Canal diversions. If the diversion demand exceeds the available DPS, the remaining amount is supplied from current Project Supply. If no DPS water is available, the entire diversion is supplied from current Project Supply. In all cases, deliveries cannot exceed the amount available in the respective account.<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] != 0.00000000 "acre-ft") THEN
            $ "Ady Canal.DiversionFromDPS" [] := "Min"( "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ), $ "Ady Canal.DiversionFromUKL" [@"t"] );

            IF_STATEMENT ($ "Ady Canal.DiversionFromUKL" [@"t"] > "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" )) THEN
            $ "Ady Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ) - $ "Ady Canal.DiversionFromUKL" [@"t"] );

      ELSE
            $ "Ady Canal.DiversionFromProjectSupply" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Ady Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), $ "Ady Canal.DiversionFromUKL" [@"t"] );

            $ "Ady Canal.DiversionFromDPS" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{68f56e92-c215-4ae5-98bf-7b9fd02ad848}";;

    RULE                 "Ady Canal Flood Control";
    DESCRIPTION          "Description: This rule defines how Ady Canal diversion demand is met during flood control operations, prioritizing LRDC, return flows and pump inflows before diverting from Upper Klamath Lake (UKL).<br><br>Logic: If the Flood Control Flag is active, diversions are supplied first from LRDC return flow up to the diversion request, then from F/FF pump inflow if additional demand remains, and finally from UKL for any remaining unmet demand. If flood control is not active, no diversion is allocated from LRDC, F/FF, or UKL under this rule.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "Ady Canal.DiversionFromLRDC" [@"t"] := "Min"( $ "LRDC into Link.Return Flow" [@"t"], $ "Ady Canal.Diversion Request" [@"t"] );

            IF_STATEMENT ($ "LRDC into Link.Return Flow" [@"t"] < $ "Ady Canal.Diversion Request" [@"t"]) THEN
            $ "Ady Canal.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "Ady Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] );

            IF_STATEMENT ($ "Ady Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] > $ "F_FF pumps.Inflow" [@"t"]) THEN
            $ "Ady Canal.DiversionFromUKL" [@"t"] := $ "Ady Canal.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] - $ "F_FF pumps.Inflow" [@"t"];

      ELSE
            $ "Ady Canal.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Ady Canal.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

            $ "Ady Canal.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      END_IF_STATEMENT;

    END
    UUID "{ff2d16a8-9480-4a58-86cd-21419d5aee28}";;

    RULE                 "Sta48 MH UKL Flood Control";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] != 0.00000000 "acre-ft") THEN
            $ "Sta48 and MH from Lost.DiversionFromDPS" [] := "Min"( "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ), $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] );

            IF_STATEMENT ($ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] > "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" )) THEN
            $ "Sta48 and MH from Lost.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ) - $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] );

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromProjectSupply" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] );

            $ "Sta48 and MH from Lost.DiversionFromDPS" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{52ee19f1-82f1-4377-bf77-00ce4f621943}";;

    RULE                 "Sta48 MH Flood Control";
    DESCRIPTION          "";
    ACTIVE               FALSE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] := $ "Sta48 and MH from Lost.Diversion Request" [@"t"];

            IF_STATEMENT ($ "LRDC from Lost River.Inflow" [@"t"] < $ "Sta48 and MH from Lost.Diversion Request" [@"t"]) THEN
            $ "Sta48 and MH from Lost.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "Sta48 and MH from Lost.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] );

            IF_STATEMENT ($ "Sta48 and MH from Lost.Diversion Request" [@"t"] - $ "LRDC from Lost River.Inflow" [@"t"] > $ "F_FF pumps.Inflow" [@"t"]) THEN
            $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := $ "Sta48 and MH from Lost.Diversion Request" [@"t"] - $ "LRDC into Link.Return Flow" [@"t"] - $ "F_FF pumps.Inflow" [@"t"];

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

            $ "Sta48 and MH from Lost.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
          INACTIVE      $ "North Canal.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

          INACTIVE      $ "North Canal.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{d989a157-7317-4068-8795-2e4dd27f6014}";;

    RULE                 "Max Storage";
    DESCRIPTION          "Description:<br>Calculate Upper Klamath Lake max storage";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Upper Klamath Lake.MaxStorage" [@"t"] := "ElevationToStorage"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Flood Control" [@"t"] );

    END
    UUID "{5b4e06a7-73b8-4a8e-91c2-4b8997f3e495}";;

    RULE                 "Flood Curve";
    DESCRIPTION          "Description:<br>Generate UKL flood curve for comparison";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Upper Klamath Lake.Flood_Curve" [@"t"] := $ "Upper Klamath Lake.Flood Control" [@"t"];

    END
    UUID "{47ebc5c9-1e0d-4106-868f-ffdec5fd0ea3}";;

    RULE                 "Set Minimum";
    DESCRIPTION          "Description:<br><br>Ensure C1 Outflow is bigger than UKL minimum flows.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Outflow" [@"t"] < $ "Upper Klamath Lake.Min Flows" [@"t"]) THEN
            $ "Upper Klamath Lake.Outflow" [@"t"] := $ "Upper Klamath Lake.Min Flows" [@"t"];

      END_IF_STATEMENT;

    END
    UUID "{027727ea-435e-40a3-bee7-f68eed3b4525}";;

    RULE                 "Get Max UKL Outflow";
    DESCRIPTION          "Description:<br>Data tracking to see UKL max release given inflow.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Upper Klamath Lake.MaxOut" [] := "GetMaxOutflowGivenInflow"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Inflow" [], @"t" );

    END
    UUID "{bfd04469-e535-4896-9665-3566dbea317b}";;

    RULE                 "Ramp Down Flow";
    DESCRIPTION          "Description:<br>Keno ramping constraints are enforced upstream at Upper Klamath Lake. If a proposed decrease in UKL outflow would violate the allowable ramp-down rate at Keno, UKL releases are increased to satisfy the downstream ramping requirement.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Outflow" [@"t"] < $ "Keno.RampFlow" [@"t"]) THEN
            $ "Upper Klamath Lake.Outflow" [@"t"] := $ "Keno.RampFlow" [@"t"];

      END_IF_STATEMENT;

    END
    UUID "{8a596b18-3cc2-45c2-8516-43caa5ee4d63}";;

    RULE                 "SFF_Down_Ramp";
    DESCRIPTION          "Description This rule controls activation of the SFF downramp switch.<br>Logic The downramp switch is set to 1 when the SFF switch turns on (i.e., it equals 1 in the current timestep and was 0 in the previous timestep). Otherwise, including on October 5, 1980, the downramp switch is set to 0.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS UKLReleases.wresl &quot;define SFF_downramp_switch&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 5" AND "GetYear"( @"Current Year" ) == 1980.00000000) THEN
            $ "OpsData.SFF_Downramp_Switch" [] := 0.00000000;

      ELSE
            $ "OpsData.SFF_Downramp_Switch" [] := 0.00000000;

      END_IF_STATEMENT
      ELSEIF_COND ( $ "OpsData.SFF_Switch" [@"t"] == 1.00000000 AND $ "OpsData.SFF_Switch" [@"t - 1"] == 0.00000000 )
      ELSEIF_CLAUSE
            $ "OpsData.SFF_Downramp_Switch" [] := 1.00000000;
      END_ELSEIF;

    END
    UUID "{b68c5872-02cd-483d-909f-76f859dc36e7}";;

    RULE                 "Keno RampDown Flow";
    DESCRIPTION          "Description:<br>When Upper Klamath Lake (UKL) outflow decreases relative to the previous day, a ramp-constrained minimum allowable flow (Keno.RampFlow) is computed based on the prior day’s UKL release minus the specified ramp-down rate. If UKL outflow is increasing or unchanged, no ramp constraint is triggered. Keno outflow is a downstream expression of UKL release decisions and is propagated through the river system via mass continuity.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Outflow" [@"t"] < $ "Upper Klamath Lake.Outflow" [@"t - 1"]) THEN
            $ "Keno.RampFlow" [@"t"] := "Max"( 0.00000000 "cfs", $ "Upper Klamath Lake.Outflow" [@"t - 1"] - $ "Keno.Ramp Down Rate" [] );

      ELSE
            $ "Keno.RampFlow" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{6452a5ca-0b25-4065-b3ca-bdc16de96e2a}";;

    RULE                 "Ramp Down Rate Max";
    DESCRIPTION          "Description:<br>Enforces Rampdown rate max is at 2000 cfs.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Keno.Ramp Down Rate" [] > 2000.00000000 "cfs") THEN
            $ "Keno.Ramp Down Rate" [] := 2000.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{217bc5fd-f31d-448b-8b59-d089403fc7a1}";;

    RULE                 "Update UKL Flood Release";
    DESCRIPTION          "Description: This rule sets Upper Klamath Lake outflow during flood control conditions, ensuring outflow meets downstream target release and diversion requirements while also meeting flood spill needs and staying within physical release capacity.<br>Logic: If the UKL Flood Control Flag is on, UKL outflow is set to the larger of (1) a computed “required outflow” to support Keno target releases and diversions (accounting for return flows, LRDC draw, F/FF inflow, and Keno accretion terms) and (2) the UKL flood spill flow; outflow is not allowed to go below zero and is capped by the maximum outflow possible given current inflow. If the Keno Flood Control Flag is on instead, the same calculation is used but flood spill is taken from the Keno flood spill term rather than the UKL flood spill term, with the same non-negativity and maximum-capacity limits.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_Keno_spill&quot; for wrims reference";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "Upper Klamath Lake.Outflow" [@"t"] := "Min"( "Max"( "Max"( $ "Keno.Target Releases" [] + $ "Diversion To Ady.Diversion" [] + $ "Diversion To North.Diversion" [] - $ "LRDC into Link.Return Flow" [] + $ "LRDC Draw From Klamath.Diversion" [] - $ "F_FF pumps.Inflow" [] - $ "Keno Accretion Positive.Local Inflow" [] + $ "Keno Accretion Diversion.Diversion" [], $ "Upper Klamath Lake.FloodSpill" [] ), 0.00000000 "cfs" ), "GetMaxOutflowGivenInflow"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Inflow" [], @"t" ) );

      END_IF_STATEMENT
      ELSEIF_COND ( $ "Keno.Flood Control Flag" [@"t"] == 1.00000000 )
      ELSEIF_CLAUSE
            $ "Upper Klamath Lake.Outflow" [@"t"] := "Min"( "Max"( "Max"( $ "Keno.Target Releases" [] + $ "Diversion To Ady.Diversion" [] + $ "Diversion To North.Diversion" [] - $ "LRDC into Link.Return Flow" [] + $ "LRDC Draw From Klamath.Diversion" [] - $ "F_FF pumps.Inflow" [] - $ "Keno Accretion Positive.Local Inflow" [] + $ "Keno Accretion Diversion.Diversion" [], $ "Keno.FloodSpill" [] ), 0.00000000 "cfs" ), "GetMaxOutflowGivenInflow"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Inflow" [], @"t" ) );
      END_ELSEIF;

    END
    UUID "{4d19adb3-efa7-4005-9fbb-dafae0fd7de2}";;

    RULE                 "Release to River";
    DESCRIPTION          "Description This rule sets Upper Klamath Lake outflow to satisfy downstream target releases and diversion demands while accounting for return flows, LRDC draw, F/FF pump inflow, and Keno accretion terms, and while staying within physical release capacity.<br><br>Logic UKL outflow is computed as the target release at Keno plus Ady and North diversions, minus LRDC return flow, plus LRDC draw, minus F/FF pump inflow, plus Keno accretion diversion and positive local inflow. The result is floored at zero and capped at the maximum outflow possible given the current UKL inflow.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Upper Klamath Lake.Outflow" [] := "Min"( "Max"( $ "Keno.Target Releases" [] + $ "Diversion To Ady.Diversion" [] + $ "Diversion To North.Diversion" [] - $ "LRDC into Link.Return Flow" [] + $ "LRDC Draw From Klamath.Diversion" [] - $ "F_FF pumps.Inflow" [] + $ "Keno Accretion Diversion.Diversion" [] + $ "Keno Accretion Positive.Local Inflow" [], 0.00000000 "cfs" ), "GetMaxOutflowGivenInflow"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Inflow" [], @"t" ) );

    END
    UUID "{234d6ccf-525c-40ae-a85d-361b93516f6f}";;

    RULE                 "UKL flood control";
    DESCRIPTION          "Description This rule activates flood control at Upper Klamath Lake when storage exceeds the maximum allowable storage and calculates the corresponding flood spill release.<br><br>Logic If yesterday’s storage exceeds yesterday’s maximum storage (with a small tolerance), the Flood Control Flag is set to 1, an alert is issued, and flood spill is calculated as the excess storage converted to flow for the current timestep. If storage does not exceed the maximum, the Flood Control Flag is set to 0 and flood spill is set to zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_Keno_spill&quot; for wrims reference.";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Storage" [@"t - 1"] + 0.10000000 "acre-ft" > $ "Upper Klamath Lake.MaxStorage" [@"t - 1"]) THEN
            ALERT_STATEMENT "Flood Contro Release from UKL";

          DESCRIPTION          "enables the flood control flag at UKL.<br>";
      $ "Upper Klamath Lake.Flood Control Flag" [@"t"] := 1.00000000;

            $ "Upper Klamath Lake.FloodSpill" [@"t"] := "VolumeToFlow"( $ "Upper Klamath Lake.Storage" [@"t - 1"] - $ "Upper Klamath Lake.MaxStorage" [@"t - 1"], @"t" );

      ELSE
            $ "Upper Klamath Lake.Flood Control Flag" [] := 0.00000000;

            $ "Upper Klamath Lake.FloodSpill" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{61c5802c-a9e0-4c34-81ab-673084c99b17}";;

    RULE                 "Keno Flood Control";
    DESCRIPTION          "Description This rule activates flood control at Keno when releases fall to the minimum flow requirement and assigns any excess release as flood spill.<br><br>Logic If the previous timestep’s Upper Klamath Lake outflow is effectively equal to or below the minimum flow requirement (within a small tolerance), the Keno Flood Control Flag is set to 1, an alert is issued, and Keno flood spill is set equal to the previous timestep’s excess flow (C13_EXC). Otherwise, the Flood Control Flag is set to 0 and flood spill is set to zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_Keno_spill&quot; for wrims reference";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Outflow" [@"t - 1"] - $ "Upper Klamath Lake.Min Flows" [@"t - 1"] < 0.10000000 "cfs") THEN
            ALERT_STATEMENT "Flood Contro Release from KENO";

          DESCRIPTION          "enables the flood control flag at UKL.<br>";
      $ "Keno.Flood Control Flag" [@"t"] := 1.00000000;

            $ "Keno.FloodSpill" [] := "c13_exc"( @"t - 1" );

      ELSE
            $ "Keno.Flood Control Flag" [@"t"] := 0.00000000;

            $ "Keno.FloodSpill" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{4aa2f078-c00a-4f43-bcba-0a7e8b4e8210}";;

  END
  UUID "{d73b0e1b-821c-4e0e-85b3-3a78eafbef6d}";;

  POLICY_GROUP   "Keno rule set";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "Keno Targeted Release";
    DESCRIPTION          "Description: This rule sets the target release at Keno based on the base flow requirement, adjusted by the Keno release multiplier and Flexible Flow Account (FFA) accounting.<br>Logic: Keno target release is the greater of: (1) the Keno river base flow, or (2) the base flow increased by the Keno release multiplier, then reduced by today’s FFA increment (FFAInc) and increased by today’s FFA usage.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS UKLReleases.wresl &quot;define C13target_temp&quot; for wrims reference";
    BEGIN

      $ "Keno.Target Releases" [] := "Max"( $ "Keno data.River Base Flow" [@"t"], $ "Keno data.River Base Flow" [@"t"] + "KenoReleaseMultiplier"( @"t" ) * $ "Keno data.River Base Flow" [@"t"] - $ "OpsData.FFAInc" [@"t"] + $ "Klamath River.FFA Usage" [@"t"] );

    END
    UUID "{48312e14-60fe-43ca-95fd-d34b301f3fe1}";;

    RULE                 "Ramp down rates";
    DESCRIPTION          "Description: This rule sets the allowable ramp-down rate for Keno outflow based on the current flow magnitude, with larger reductions allowed at higher flows.<br>Logic: If Keno outflow is less than 1,400 cfs, the ramp-down rate is 150 cfs. If less than 2,800 cfs, the rate is 300 cfs. If less than 3,100 cfs, the rate is 600 cfs. If less than 3,500 cfs, the rate is limited to the amount above 2,500 cfs (not less than zero). If less than 4,100 cfs, the rate is 1,000 cfs. If 4,100 cfs or greater, the ramp-down rate is the lesser of 2,000 cfs or the amount above 3,100 cfs from the previous timestep, not less than zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Data found in BiOp appendix E, pg 25<br><br>";
    BEGIN

      IF_STATEMENT ($ "Keno.Outflow" [] < 1400.00000000 "cfs") THEN
            $ "Keno.Ramp Down Rate" [] := 150.00000000 "cfs";

      ELSE
            $ "Keno.Ramp Down Rate" [] := "Min"( 2000.00000000 "cfs", "Max"( $ "Keno.Outflow" [@"t - 1"] - 3100.00000000 "cfs", 0.00000000 "cfs" ) );

      END_IF_STATEMENT
      ELSEIF_COND ( $ "Keno.Outflow" [] < 2800.00000000 "cfs" )
      ELSEIF_CLAUSE
            $ "Keno.Ramp Down Rate" [] := 300.00000000 "cfs";
      END_ELSEIF
      ELSEIF_COND ( $ "Keno.Outflow" [] < 3100.00000000 "cfs" )
      ELSEIF_CLAUSE
            $ "Keno.Ramp Down Rate" [] := 600.00000000 "cfs";
      END_ELSEIF
      ELSEIF_COND ( $ "Keno.Outflow" [] < 3500.00000000 "cfs" )
      ELSEIF_CLAUSE
            $ "Keno.Ramp Down Rate" [] := "Max"( 0.00000000 "cfs", $ "Keno.Outflow" [@"t - 1"] - 2500.00000000 "cfs" );
      END_ELSEIF
      ELSEIF_COND ( $ "Keno.Outflow" [] < 4100.00000000 "cfs" )
      ELSEIF_CLAUSE
            $ "Keno.Ramp Down Rate" [] := 1000.00000000 "cfs";
      END_ELSEIF
      ELSEIF_COND ( $ "Keno.Outflow" [] >= 4100.00000000 "cfs" )
      ELSEIF_CLAUSE
            $ "Keno.Ramp Down Rate" [] := "Min"( 2000.00000000 "cfs", "Max"( $ "Keno.Outflow" [@"t - 1"] - 3100.00000000 "cfs", 0.00000000 "cfs" ) );
      END_ELSEIF;

    END
    UUID "{f6ab3838-472a-4930-9002-f5c9d541561f}";;

  END
  UUID "{f948a900-dadf-4147-9e8a-2ebc52be2392}";;

  POLICY_GROUP   "Indexes and daily calculators";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "Ops Index and Logs";
    DESCRIPTION          "Description: This rule calculates the overall Operations Index used to guide system operations.<br>Logic: The Operations Index is computed as the average of the 14-day moving average Normalized Wetness Index (NWI) and the Upper Klamath Lake Lake Index.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define Ops_index&quot; for wrims reference";
    BEGIN

      $ "OpsData.OpsIndex" [] := ( $ "OpsData.NWI_14dayAvg" [] + $ "Upper Klamath Lake.Lake Index" [] ) / 2.00000000;

    END
    UUID "{c5a81af5-da77-4be4-b35e-39e626106746}";;

    RULE                 "Lake Index";
    DESCRIPTION          "Description: Calculates the Upper Klamath Lake Index as a normalized measure of lake shadow elevation relative to defined upper and lower bounds.<br>Logic: The index is computed by scaling the previous timestep’s shadow elevation between the UKL lower and upper bounds. ";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_status&quot; for wrims reference";
    BEGIN

      $ "Upper Klamath Lake.Lake Index" [] := "Min"( 1.00000000, "Max"( 0.00000000, ( $ "Upper Klamath Lake.Shadow Elevation" [@"t - 1"] - $ "Upper Klamath Lake.UKL lower bound" [@"t - 1"] ) / ( $ "Upper Klamath Lake.UKL upper bound" [@"t - 1"] - $ "Upper Klamath Lake.UKL lower bound" [@"t - 1"] ) ) );

    END
    UUID "{3423535c-90be-4de1-bd27-1bbfc5b23cdd}";;

    RULE                 "Shadow Elevation";
    DESCRIPTION          "Description: Convert Upper Klamath Lake Shadow Storage to Shadow Elevation using StorageToElevation function.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_shadow_lvl&quot; for wrims reference";
    BEGIN

      $ "Upper Klamath Lake.Shadow Elevation" [] := "StorageToElevation"( % "Upper Klamath Lake", $ "Upper Klamath Lake.ShadowStorage" [] );

    END
    UUID "{fe42d757-5841-455d-a94e-cb35394b17a8}";;

    RULE                 "Shadow Storage";
    DESCRIPTION          "Description: This rule calculates the effective (shadow) storage at Upper Klamath Lake after accounting for reserved water.<br>Logic: Shadow storage is equal to the previous timestep’s total storage minus the Deferred Project Supply Account balance and minus the Flexible Flow accounting balance.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define UKL_shadow_stor_&quot; for wrims reference";
    BEGIN

      $ "Upper Klamath Lake.ShadowStorage" [] := $ "Upper Klamath Lake.Storage" [@"t - 1"] - $ "Upper Klamath Lake.Deferred Project Supply Account" [] - $ "OpsData.FFAccounting" [];

    END
    UUID "{51bc3659-ad41-4ed3-b1c8-d0cee46d426d}";;

    RULE                 "14 day NWI average";
    DESCRIPTION          "Description: Calculate 14 Day trailing average of NWI";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Inflow-table.wresl &quot;define norm_wet_index&quot; for wrims reference";
    BEGIN

      $ "OpsData.NWI_14dayAvg" [] := "SumSlot"( $ "Historical Inflows and NWI.NWI", @"t - 13", @"t" ) / 14.00000000;

    END
    UUID "{89d97182-f67a-45a7-a144-35a1053b3d5a}";;

  END
  UUID "{99ea40d1-8e1f-4e1c-b26e-02f9c4e81f1f}";;

  POLICY_GROUP   "Diversion Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "North Canal FW SS Diversion";
    DESCRIPTION          "Description: This rule classifies North Canal diversions from Upper Klamath Lake as either Spring Summer (SS) or Fall/Winter (FW) based on the time of year.<br>Logic: From March 1 through September 30, all North Canal diversions from UKL are assigned to the Spring Summer and none to Fall/Winter. From January 1 through the end of February, and from October 1 through December 31, all diversions are assigned to the Fall/Winter category and none to Spring Summer.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT (@"t" >= @"March 1" AND @"t" <= @"September 30") THEN
            $ "North Canal.DiversionFromUKL_SS" [@"t"] := $ "North Canal.DiversionFromUKL" [@"t"];

            $ "North Canal.DiversionFromUKL_FW" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" < @"March 1" AND @"t" >= @"January 1" )
      ELSEIF_CLAUSE
            $ "North Canal.DiversionFromUKL_FW" [@"t"] := $ "North Canal.DiversionFromUKL" [@"t"];
            $ "North Canal.DiversionFromUKL_SS" [@"t"] := 0.00000000 "cfs";
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"October" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "North Canal.DiversionFromUKL_FW" [@"t"] := $ "North Canal.DiversionFromUKL" [@"t"];
            $ "North Canal.DiversionFromUKL_SS" [@"t"] := 0.00000000 "cfs";
      END_ELSEIF;

    END
    UUID "{2c080dec-f574-4e90-b35e-63af66410fcc}";;

    RULE                 "North Canal FF Diversion";
    DESCRIPTION          "Description: This rule determines whether F/FF pump inflow is needed to meet the North Canal diversion request after accounting for LRDC and UKL supplies.<br>Logic: If the combined diversions from LRDC and UKL are less than the North Canal diversion request, the remaining unmet demand is supplied from F/FF pump inflow, up to the amount available. If LRDC and UKL together meet or exceed the diversion request, no water is diverted from F/FF pumps.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "North Canal.DiversionFromLRDC" [@"t"] + $ "North Canal.DiversionFromUKL" [@"t"] < $ "North Canal.Diversion Request" [@"t"]) THEN
            $ "North Canal.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "North Canal.Diversion Request" [@"t"] - $ "North Canal.DiversionFromUKL" [@"t"] - $ "North Canal.DiversionFromLRDC" [@"t"] );

      ELSE
            $ "North Canal.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{ae31e199-2286-4c65-8e8c-48fa29e0e9c3}";;

    RULE                 "North Canal LRDC Diversion";
    DESCRIPTION          "Description: This rule determines how much of the North Canal diversion request is supplied by LRDC return flow after accounting for diversions from Upper Klamath Lake.<br>Logic: If diversion from UKL is less than the North Canal diversion request, the remaining unmet demand is supplied from LRDC return flow, up to the amount available. If UKL diversion meets or exceeds the request, no water is diverted from LRDC.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "North Canal.DiversionFromUKL" [@"t"] < $ "North Canal.Diversion Request" [@"t"]) THEN
            $ "North Canal.DiversionFromLRDC" [@"t"] := "Min"( $ "LRDC into Link.Return Flow" [@"t"], $ "North Canal.Diversion Request" [@"t"] - $ "North Canal.DiversionFromUKL" [@"t"] );

      ELSE
            $ "North Canal.DiversionFromLRDC" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{77894f48-9c54-4a43-bd5c-a5af9b32a253}";;

    RULE                 "North Canal UKL Diversion";
    DESCRIPTION          "Description This rule limits North Canal diversion from Upper Klamath Lake based on available LRDC inflow.<br>Logic Diversion from UKL is set equal to the lesser of the North Canal diversion request and the available LRDC inflow/UKL Outflow for the timestep.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      $ "North Canal.DiversionFromUKL" [@"t"] := "Min"( $ "North Canal.Diversion Request" [@"t"], $ "LRDC into Link.Inflow" [@"t"] );

    END
    UUID "{1cfd7ec1-ac0d-4c3b-b232-1b8c91f90138}";;

    RULE                 "Ady Canal FF Diversion";
    DESCRIPTION          "Description: This rule determines whether F/FF pump inflow is needed to meet the Ady Canal project deliveries after accounting for LRDC and UKL supplies.<br>Logic: If the combined diversions from LRDC and UKL are less than the Ady Canal project deliveries, the remaining unmet demand is supplied from F/FF pump inflow, up to the amount available. If LRDC and UKL together meet or exceed the To Project amount, no water is diverted from F/FF pumps.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Ady Canal.DiversionFromLRDC" [@"t"] + $ "Ady Canal.DiversionFromUKL" [@"t"] < $ "Ady Canal.To Project" [@"t"]) THEN
            $ "Ady Canal.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "Ady Canal.To Project" [@"t"] - $ "Ady Canal.DiversionFromUKL" [@"t"] - $ "Ady Canal.DiversionFromLRDC" [@"t"] );

      ELSE
            $ "Ady Canal.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{504c1436-db01-45fa-9375-0c437c593e14}";;

    RULE                 "Ady Canal LRDC Diversion";
    DESCRIPTION          "Description: This rule determines whether LRDC return flow is needed to meet Ady Canal project deliveries after accounting for diversions from Upper Klamath Lake.<br>Logic: If diversion from UKL is less than the Ady Canal delivery to the Project, the remaining unmet demand is supplied from LRDC return flow, up to the amount available. If UKL diversion meets or exceeds the Project delivery, no water is diverted from LRDC.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Ady Canal.DiversionFromUKL" [@"t"] < $ "Ady Canal.To Project" [@"t"]) THEN
            $ "Ady Canal.DiversionFromLRDC" [@"t"] := "Min"( $ "LRDC into Link.Return Flow" [@"t"], $ "Ady Canal.To Project" [@"t"] - $ "Ady Canal.DiversionFromUKL" [@"t"] );

      ELSE
            $ "Ady Canal.DiversionFromLRDC" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{2b647bd7-cc68-44c9-b54c-68740fe447cc}";;

    RULE                 "Ady Canal FW SS Diversion";
    DESCRIPTION          "Description: This rule classifies Ady Canal project deliveries from Upper Klamath Lake as either Spring Summer (SS) or Fall/Winter (FW) based on the time of year.<br>Logic: From March 1 through September 30, all Ady Canal delivieries from UKL are assigned to the Spring Summer and none to Fall/Winter. From January 1 through the end of February, and from October 1 through December 31, all diversions are assigned to the Fall/Winter category and none to Spring Summer.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT (@"t" >= @"March 1" AND @"t" <= @"September 30") THEN
            $ "Ady Canal.DiversionFromUKL_SS" [@"t"] := $ "Ady Canal.DiversionFromUKL" [@"t"];

            $ "Ady Canal.DiversionFromUKL_FW" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" < @"March 1" AND @"t" >= @"January 1" )
      ELSEIF_CLAUSE
            $ "Ady Canal.DiversionFromUKL_FW" [@"t"] := $ "Ady Canal.DiversionFromUKL" [@"t"];
            $ "Ady Canal.DiversionFromUKL_SS" [@"t"] := 0.00000000 "cfs";
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"October" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "Ady Canal.DiversionFromUKL_FW" [@"t"] := $ "Ady Canal.DiversionFromUKL" [@"t"];
            $ "Ady Canal.DiversionFromUKL_SS" [@"t"] := 0.00000000 "cfs";
      END_ELSEIF;

    END
    UUID "{23385691-4bdb-40f0-8b29-44091f3bd0d3}";;

    RULE                 "Ady Canal UKL Diversion";
    DESCRIPTION          "Description This rule limits Ady Canal project deliveries from Upper Klamath Lake based on available LRDC inflow.<br>Logic Diversion from UKL is set equal to the lesser of the Ady Canal project deliveries and the available LRDC inflow/UKL Outflow for the timestep.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      $ "Ady Canal.DiversionFromUKL" [@"t"] := "Min"( $ "Ady Canal.To Project" [@"t"], $ "LRDC into Link.Inflow" [@"t"] );

    END
    UUID "{8148ef40-1723-422c-96f4-5002533b9ad5}";;

    RULE                 "Sta48 and MH from Lost FF Diversion";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] + $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] < $ "Sta48 and MH from Lost.Diversion Request" [@"t"]) THEN
            $ "Sta48 and MH from Lost.DiversionFromFF" [@"t"] := "Min"( $ "F_FF pumps.Inflow" [@"t"], $ "Sta48 and MH from Lost.Diversion Request" [@"t"] - $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] - $ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] );

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromFF" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{0c1c552c-10e9-4b22-b4d9-909b2d8d8411}";;

    RULE                 "Sta48 and MH from Lost UKLDiversion";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

    INACTIVE      IF_STATEMENT ($ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] < $ "Sta48 and MH from Lost.Diversion Request" [@"t"]) THEN
            $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := "Min"( $ "LRDC Draw From Klamath.Inflow" [@"t"], $ "Sta48 and MH from Lost.Diversion Request" [@"t"] - $ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] );

      ELSE
            $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t"] := $ "Div To LRDC.Diversion Request" [];

    END
    UUID "{2a40cacb-1a8a-4138-b112-86d7f9582238}";;

    RULE                 "Sta48 and MH from Lost LRDC Diversion";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Sta48 and MH from Lost.DiversionFromLRDC" [@"t"] := $ "Sta48 and MH from Lost.Diversion Request" [@"t"];

    END
    UUID "{ca595762-9767-42d6-9537-bd342a16d29f}";;

    RULE                 "A Canal Diversion";
    DESCRIPTION          "Description: This rule allocates A Canal diversion demand between the Deferred Project Supply Account (DPS) and current Project Supply.<br>Logic: If DPS water is available, A Canal diverts from DPS first up to the diversion request. If the request exceeds available DPS, the remaining demand is intended to be met from Project Supply (limited by Project Supply availability); otherwise Project Supply diversion is held at the prior timestep value. If no DPS is available, A Canal diversion is supplied from Project Supply up to the diversion request.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Reference: Appendix C-33";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] != 0.00000000 "acre-ft") THEN
            $ "A Canal.DiversionFromDPS" [] := "Min"( "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ), $ "A Canal.Diversion Request" [@"t"] );

            IF_STATEMENT ($ "A Canal.Diversion Request" [@"t"] > "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" )) THEN
            $ "A Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [], @"t" ) - $ "A Canal.Diversion Request" [@"t"] );

      ELSE
            $ "A Canal.DiversionFromProjectSupply" [@"t"] := $ "A Canal.DiversionFromProjectSupply" [@"t - 1"];

      END_IF_STATEMENT;

      ELSE
            $ "A Canal.DiversionFromProjectSupply" [] := "Min"( "VolumeToFlow"( $ "OpsData.ProjectSupplyAccounting" [], @"t" ), $ "A Canal.Diversion Request" [@"t"] );

      END_IF_STATEMENT;

    END
    UUID "{3488b621-37da-499d-b880-cc2c97aab734}";;

    RULE                 "Ady Refuge Diversion from UKL";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "Ady Canal.ToRefugeFromUKL" [@"t"] := 0.00000000 "cfs";

      ELSE
            $ "Ady Canal.ToRefugeFromUKL" [@"t"] := "Min"( $ "Ady Canal.ToRefuge" [@"t"], $ "LRDC Draw From Klamath.Inflow" [@"t"] );

      END_IF_STATEMENT;

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 0.00000000) THEN
            $ "Ady Canal.ToRefugeFromDPS" [@"t"] := 0.00000000 "cfs";

            $ "Ady Canal.ToRefugeFromLP" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{9ece23b8-61f2-4b7a-aeaf-94b391c27b37}";;

    RULE                 "Ady Refuge Flood DPS";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            IF_STATEMENT ($ "Ady Canal.ToRefugeFromLRDC" [@"t"] < $ "Ady Canal.ToRefuge" [@"t"]) THEN
            $ "Ady Canal.ToRefugeFromDPS" [@"t"] := $ "Ady Canal.ToRefuge" [@"t"] - $ "Ady Canal.ToRefugeFromLRDC" [@"t"];

      ELSE
            $ "Ady Canal.ToRefugeFromDPS" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Ady Canal.ToRefugeFromDPS" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{22cf931b-3e4d-4d2b-9a46-037be65962d3}";;

    RULE                 "Ady Refuge Flood LP";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            IF_STATEMENT ($ "Ady Canal.ToRefugeFromLRDC" [@"t"] + $ "Ady Canal.ToRefugeFromDPS" [@"t"] < $ "Ady Canal.ToRefuge" [@"t"] AND $ "OpsData.FFAccounting" [] == 0.00000000 "acre-ft") THEN
            $ "Ady Canal.ToRefugeFromLP" [] := $ "Ady Canal.ToRefuge" [@"t"] - $ "Ady Canal.ToRefugeFromDPS" [@"t"] - $ "Ady Canal.ToRefugeFromLRDC" [@"t"];

      ELSE
            $ "Ady Canal.ToRefugeFromLP" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

      ELSE
            $ "Ady Canal.ToRefugeFromLP" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{43923eaa-a9c4-4971-852c-8e44a8d1647f}";;

    RULE                 "Ady Refuge LRDC";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Still need to figure LP";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t"] == 1.00000000) THEN
            $ "Ady Canal.ToRefugeFromLRDC" [@"t"] := "Min"( $ "Ady Canal.ToRefuge" [@"t"], $ "LRDC into Link.Return Flow" [@"t"] );

      ELSE
            $ "Ady Canal.ToRefugeFromLRDC" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{af0aca3a-cb52-4b91-91a0-13ee13e1bdab}";;

    RULE                 "Ady Refuge Diversion from FF";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Ady Canal.ToRefugeFromFF" [@"t"] := 0.00000000 "cfs";

    END
    UUID "{e6e03f7b-3890-4b89-b620-8d68a23353d4}";;

  END
  UUID "{7fd17c67-01e9-4917-a9df-caa41984c689}";;

  POLICY_GROUP   "FFA";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "FFA Accounting";
    DESCRIPTION          "Description: This rule updates the Flexible Flow (FF) account balance each day and resets it at the start of the water year.<br>Logic: On October 1, the FF account is reset to zero. On all other days, today’s FF balance equals yesterday’s balance plus yesterday’s FFA savings, minus yesterday’s FFA spill, minus the volume of yesterday’s FFA usage (converted from flow to volume for the timestep). The balance cannot go below zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define Flexible_Flow_Account&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "OpsData.FFAccounting" [@"t"] := 0.00000000 "acre-ft";

      ELSE
            $ "OpsData.FFAccounting" [@"t"] := "Max"( 0.00000000 "acre-ft", $ "OpsData.FFAccounting" [@"t - 1"] + $ "OpsData.YestFFASavings" [@"t"] - $ "OpsData.yest_FFA_Spill" [@"t"] - "FlowToVolume"( $ "Klamath River.yest_FFA_Usage" [@"t"], @"t" ) );

      END_IF_STATEMENT;

    END
    UUID "{741a36e2-fd45-4733-b6fd-0911d232d300}";;

    RULE                 "yest_FFA_Usage";
    DESCRIPTION          "Description This rule determines the amount of Flexible Flow Account (FFA) usage credited to the previous day and resets it at the start of the water year.<br>Logic On October 1, yesterday’s FFA usage is set to zero. On all other days, it is set equal to the lesser of the previous day’s FFA Usage and the previous day’s excess flow (c1_exc function).";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define Yest_FFA_Savings&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "Klamath River.yest_FFA_Usage" [] := 0.00000000 "cfs";

      ELSE
            $ "Klamath River.yest_FFA_Usage" [] := "Min"( $ "Klamath River.FFA Usage" [@"t - 1"], "C1_exc"( @"t - 1" ) );

      END_IF_STATEMENT;

    END
    UUID "{a19286e4-5d1d-44d0-871c-806d2d948c52}";;

    RULE                 "FFA Usage";
    DESCRIPTION          "Description: This rule sets the daily Flexible Flow Account (FFA) usage rate based on whether the Spring Flushing Flow (SFF) switch is turned on, ramping down, or operating during March–June, and it constrains usage to available account balance when applicable.<br>Logic: FFA Usage is zero by default. When SFF turns on (SFF=1 today and 0 yesterday), FFA Usage is the smaller of (a) the flow needed to raise base flow up to the SFF threshold and (b) 30% of the current FFA balance converted to flow. When the SFF downramp switch is active while SFF remains on, FFA Usage is set to the flow needed to meet the Keno ramping flow minus the base-plus-multiplier target (not less than zero). If SFF is oon FFA Usage is set to spread the remaining FFA evenly over the days remaining until July 1. If SFF is off during March 2–June 30, FFA Usage is set to a fixed daily amount based on the March 1 FFA divided across 121 days (converted to flow).";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS UKLReleases.wresl &quot;define FFA_use&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 5" AND "GetYear"( @"Current Year" ) == 1980.00000000) THEN
            $ "Klamath River.FFA Usage" [] := 0.00000000 "cfs";

      ELSE
            $ "Klamath River.FFA Usage" [] := 0.00000000 "cfs";

      END_IF_STATEMENT
      ELSEIF_COND ( $ "OpsData.SFF_Switch" [@"t - 1"] == 0.00000000 AND $ "OpsData.SFF_Switch" [@"t"] == 1.00000000 )
      ELSEIF_CLAUSE
            $ "Klamath River.FFA Usage" [] := "Min"( "Max"( 0.00000000 "cfs", $ "OpsData.SFF_Thresh" [] - $ "Keno data.River Base Flow" [@"t"] ), 0.30000000 * "VolumeToFlow"( $ "OpsData.FFAccounting" [@"t"], @"t" ) );
      END_ELSEIF
      ELSEIF_COND ( $ "OpsData.SFF_Downramp_Switch" [] == 1.00000000 AND $ "OpsData.SFF_Switch" [@"t"] == 1.00000000 )
      ELSEIF_CLAUSE
            $ "Klamath River.FFA Usage" [] := "Max"( 0.00000000 "cfs", $ "Keno.RampFlow" [] - ( $ "Keno data.River Base Flow" [@"t"] + "KenoReleaseMultiplier"( @"t" ) * $ "Keno data.River Base Flow" [@"t"] ) );
      END_ELSEIF
      ELSEIF_COND ( $ "OpsData.SFF_Switch" [@"t"] == 1.00000000 AND ( @"t" > @"March 1" AND @"t" <= @"June 30" ) )
      ELSEIF_CLAUSE
            $ "Klamath River.FFA Usage" [@"t"] := "VolumeToFlow"( $ "OpsData.FFAccounting" [@"t"], @"t" ) / ( @"24:00:00 July 1, Current Year" - @"t" ) * 1.00000000 "day";
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" <= @"June 30" AND $ "OpsData.SFF_Switch" [@"t"] == 0.00000000 )
      ELSEIF_CLAUSE
            $ "Klamath River.FFA Usage" [@"t"] := "VolumeToFlow"( $ "OpsData.FFAccounting" [@"24:00:00 March 1, Current Year"] / 121.00000000, @"t" );
      END_ELSEIF;

    END
    UUID "{fa834b55-c845-4d73-a072-b7eafb1221ee}";;

    RULE                 "Yest FFA Spill";
    DESCRIPTION          "Description: This rule calculates the volume of FFA spill credited to the previous day during Upper Klamath Lake flood control conditions and resets spill to zero on October 1.<br>Logic: On October 1, yesterday’s FFA spill is set to zero. Otherwise calculated when the prior day’s UKL Flood Control Flag is on. In that case, yesterday’s FFA spill is the smaller of (a) yesterday’s C1 excess volume and (b) yesterday’s adjusted C13 excess volume (C13_EXC minus LRDC return flow and pumped storage contribution), minus the volume of DPS spill; the result cannot be negative.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS SeasonalSupply.wresl &quot;define Yest_FFA_Spill&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "OpsData.yest_FFA_Spill" [] := 0.00000000 "acre-ft";

      ELSE
            $ "OpsData.yest_FFA_Spill" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( $ "Upper Klamath Lake.Flood Control Flag" [@"t - 1"] == 1.00000000 )
      ELSEIF_CLAUSE
            $ "OpsData.yest_FFA_Spill" [] := "Max"( 0.00000000 "acre-ft", "Min"( "FlowToVolume"( "C1_exc"( @"t - 1" ), @"t" ), "FlowToVolume"( "c13_exc"( @"t - 1" ) - $ "LRDC into Link.Return Flow" [@"t - 1"] - $ "Keno.Flow FROM Pumped Storage" [@"t - 1"], @"t" ) ) - "FlowToVolume"( $ "LakeData.DPS Spill" [], @"t" ) );
      END_ELSEIF;

    END
    UUID "{6c89cda2-a760-4f23-bb67-1f9929d7bafb}";;

    RULE                 "SFF_Switch";
    DESCRIPTION          "Description: This rule controls when the Spring Flushing Flow (SFF) event is turned on, and keeps it off outside the spring evaluation window.<br>Logic The SFF switch is forced off from October 1 through December 31 and from January 1 through the end of February. Otherwise it carries forward yesterday’s value unless triggered on in early spring. Between March 1 and April 9, if an SFF event has not already occurred and there is a positive FFA balance, SFF turns on when either Keno flood control was active the prior day or I15 Inflow exceeds its threshold, and the prior-day Operations Index is at or below the OPI threshold. On April 10, if an SFF event has not already occurred and FF accounting is positive, SFF is turned on regardless of the other spring triggers.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Operations_Switches.wresl &quot;define switch_SFF&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" >= @"October 1" AND @"t" <= @"December 31") THEN
            $ "OpsData.SFF_Switch" [@"t"] := 0.00000000;

      ELSE
            $ "OpsData.SFF_Switch" [@"t"] := $ "OpsData.SFF_Switch" [@"t - 1"];

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.SFF_Switch" [@"t"] := 0.00000000;
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"March 1" AND @"t" < @"April 10" AND $ "OpsData.SFF_Already_Hap" [] == 0.00000000 AND ( $ "Keno.Flood Control Flag" [@"t - 1"] == 1.00000000 OR $ "Historical Inflows and NWI.I15" [@"t - 1"] > $ "OpsData.kiga_threshold" [@"t"] ) AND $ "OpsData.OpsIndex" [@"t - 1"] <= $ "OpsData.OPI_Thresh" [] AND $ "OpsData.FFAccounting" [] > 0.00000000 "acre-ft" )
      ELSEIF_CLAUSE
            $ "OpsData.SFF_Switch" [@"t"] := 1.00000000;
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 10" AND $ "OpsData.SFF_Already_Hap" [] == 0.00000000 AND $ "OpsData.FFAccounting" [] > 0.00000000 "acre-ft" )
      ELSEIF_CLAUSE
            $ "OpsData.SFF_Switch" [@"t"] := 1.00000000;
      END_ELSEIF;

    END
    UUID "{30e41084-e07e-484d-9ebb-d6b717c883f0}";;

    RULE                 "SFF_Already_Hap";
    DESCRIPTION          "Description: This rule tracks whether a Spring Flushing Flow (SFF) event has already occurred during the current season.<br>Logic: The flag is reset to 0 from October 1 through December 31 and during January. From February 1 through April 30, the flag is set to 1 if either the previous day’s Keno outflow exceeded the SFF threshold or the SFF switch was on the previous day; otherwise it carries forward yesterday’s value.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Operations_Switches.wresl &quot;define SFF_already_hap_&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" >= @"October 1" AND @"t" <= @"December 31") THEN
            $ "OpsData.SFF_Already_Hap" [@"t"] := 0.00000000;

      ELSE
            $ "OpsData.SFF_Already_Hap" [@"t"] := $ "OpsData.SFF_Already_Hap" [@"t - 1"];

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"February 1" )
      ELSEIF_CLAUSE
            $ "OpsData.SFF_Already_Hap" [@"t"] := 0.00000000;
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"February 1" AND @"t" < @"May 1" )
      ELSEIF_CLAUSE
            IF_STATEMENT ($ "Keno.Outflow" [@"t - 1"] > $ "OpsData.SFF_Thresh" [] OR $ "OpsData.SFF_Switch" [@"t - 1"] == 1.00000000) THEN
            $ "OpsData.SFF_Already_Hap" [@"t"] := 1.00000000;

      ELSE
            $ "OpsData.SFF_Already_Hap" [@"t"] := $ "OpsData.SFF_Already_Hap" [@"t - 1"];

      END_IF_STATEMENT;
      END_ELSEIF;

    END
    UUID "{5525b89f-7f5e-4714-bb09-618805d0dcf1}";;

    RULE                 "Yest FFA Savings";
    DESCRIPTION          "Description: This rule records the prior day’s FFA savings and resets the value at the start of the water year.<br>Logic: On October 1, yesterday’s FFA savings is set to zero. On all other days, it is set equal to the calculated value of “Yesterday’s FFA Saving” for the current timestep.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS UKLSeasonalSupply.wresl &quot;define Yest_FFA_Savings&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "OpsData.YestFFASavings" [@"t"] := 0.00000000 "acre-ft";

      ELSE
            $ "OpsData.YestFFASavings" [@"t"] := "Yesterday's FFA Saving"( @"t" );

      END_IF_STATEMENT;

    END
    UUID "{038a637a-969a-4769-bd30-82591d9789ff}";;

    RULE                 "FFA Stored";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Code has broken FFA accumulation ruleset into two separate lines of code because the year change between october and March 2 breaks the code<br><br>FFA releases are scheduled <br>FFA increment is 0 if flooding<br><br>need to load in ffa-increment ==0";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "River Data.FFA Increment" [@"t"] := 0.00000000 "acre-ft";

      ELSE
            $ "River Data.FFA Increment" [@"t"] := $ "River Data.FFA Increment" [@"t - 1"];

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"October 2" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "River Data.FFA Increment" [@"t"] := $ "River Data.FFA Increment" [@"t - 1"] + "FlowToVolume"( $ "OpsData.FFAInc" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" <= @"March 1" )
      ELSEIF_CLAUSE
            $ "River Data.FFA Increment" [@"t"] := $ "River Data.FFA Increment" [@"t - 1"] + "FlowToVolume"( $ "OpsData.FFAInc" [], @"t" );
      END_ELSEIF;

    END
    UUID "{0cb69d1c-5adb-4404-8bce-92d6c68cc6d8}";;

    RULE                 "FFA_Inc";
    DESCRIPTION          "Description: This rule sets the daily Flexible Flow Account (FFA) increment rate and only accrues increment when the FF account is below the volume limit.<br>Logic: FFAInc is zero by default (and on October 1). From October 2–December 31 and from January 1–March 1, if the FF account balance is below the FFA volume limit, FFAInc is set equal to the calculated “FFA increment” value for the day; otherwise it remains zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS UKLSeasonalSupply.wresl &quot;define FFA_inc&quot; for wrims reference<br>";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1") THEN
            $ "OpsData.FFAInc" [@"t"] := 0.00000000 "cfs";

      ELSE
            $ "OpsData.FFAInc" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" > @"October 1" AND @"t" <= @"December 31" AND $ "OpsData.FFAccounting" [@"t"] < $ "OpsData.FFA_vol_limit" [] )
      ELSEIF_CLAUSE
            $ "OpsData.FFAInc" [@"t"] := "FFA increment"( @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" <= @"March 1" AND $ "OpsData.FFAccounting" [@"t"] < $ "OpsData.FFA_vol_limit" [] )
      ELSEIF_CLAUSE
            $ "OpsData.FFAInc" [@"t"] := "FFA increment"( @"t" );
      END_ELSEIF;

    END
    UUID "{0dea0dce-774c-4b4b-a67c-345e9e9ed91b}";;

    RULE                 "Calculate Kiga Threshold";
    DESCRIPTION          "Description This rule calculates the KIGA inflow threshold used in SFF decision-making.<br>Logic The KIGA threshold is determined by interpolating from the Kiga threshold lookup table using the current Operations Index as the input.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Operations_Switches.wresl &quot;define kiga_thresh&quot; for wrims reference<br>";
    BEGIN

      $ "OpsData.kiga_threshold" [] := "TableInterpolation"( $ "OpsData.Kiga_Thresh_Lookup", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );

    END
    UUID "{ba302b94-96d7-4667-85af-f8c2f87cefae}";;

  END
  UUID "{52b384c8-b267-4578-96c8-0b7fa7f426e7}";;

  POLICY_GROUP   "Deferred Project Supply Accounting";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "DPS accounting";
    DESCRIPTION          "Description:This rule updates the Deferred Project Supply Account (DPSA) balance at Upper Klamath Lake and resets it on November 1.<br>Logic: On November 1, the DPSA is set to zero. From November 2–December 31 and from January 1–September 30 the DPSA is updated as yesterday’s DPSA plus daily flow savings plus the refuge daily cap, minus prior-day Project DPS diversions, minus prior-day refuge deliveries from DPS (converted to volume), minus DPS spill (converted to volume). The balance is floored at zero (cannot go negative).";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define UKL_Prj_Credit&quot; for wrims reference<br>";
    BEGIN

      IF_STATEMENT (@"t" == @"November 1") THEN
            $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] := 0.00000000 "acre-ft";

      ELSE
            $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" > @"November 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] := "Max"( 0.00000000 "acre-ft", $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t - 1"] + $ "Upper Klamath Lake.Daily Flow Savings" [@"t - 1"] + $ "Refuge Policy Tracking.RefugeDailyCap" [] - $ "OpsData.Proj DPS Div" [@"t - 1"] - "FlowToVolume"( $ "Ady Canal.ToRefugeFromDPS" [@"t - 1"], @"t" ) - "FlowToVolume"( $ "LakeData.DPS Spill" [], @"t" ) );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" <= @"September 30" )
      ELSEIF_CLAUSE
            $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] := "Max"( 0.00000000 "acre-ft", $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t - 1"] + $ "Upper Klamath Lake.Daily Flow Savings" [@"t - 1"] + $ "Refuge Policy Tracking.RefugeDailyCap" [] - $ "OpsData.Proj DPS Div" [@"t - 1"] - "FlowToVolume"( $ "Ady Canal.ToRefugeFromDPS" [@"t - 1"], @"t" ) - "FlowToVolume"( $ "LakeData.DPS Spill" [], @"t" ) );
      END_ELSEIF;

    END
    UUID "{ba582b44-c160-483c-abd2-cf59bfd2064a}";;

    RULE                 "Yest_DPS Spill v1";
    DESCRIPTION          "Description: This rule calculates the portion of flood-control excess flow that is counted as spill from the Deferred Project Supply (DPS) account.<br>Logic: DPS spill is only computed when UKL flood control was active the previous day; otherwise it is zero. When active, DPS spill is set to a non-negative flow limited by the smallest of: (1) yesterday’s excess UKL outflow (C1_EXC), (2) yesterday’s excess Keno flow net of project contributions, and (3) the DPS water available after accounting for prior-day Project DPS diversions and refuge DPS deliveries, plus today’s daily flow savings (all expressed as flow).";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define Yest_PC_Spill&quot; for wrims reference<br>";
    BEGIN

      IF_STATEMENT ($ "Upper Klamath Lake.Flood Control Flag" [@"t - 1"] == 1.00000000) THEN
            $ "LakeData.DPS Spill" [] := "Max"( 0.00000000 "cfs", "Min"( "C1_exc"( @"t - 1" ), "Min"( "c13_exc"( @"t - 1" ) - $ "Keno data.Project Contributions to Keno Flows" [@"t - 1"], "VolumeToFlow"( $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t - 1"], @"t" ) - "VolumeToFlow"( $ "OpsData.Proj DPS Div" [@"t - 1"], @"t" ) - $ "Ady Canal.ToRefugeFromDPS" [@"t - 1"] + "VolumeToFlow"( $ "Upper Klamath Lake.Daily Flow Savings" [], @"t" ) ) ) );

      ELSE
            $ "LakeData.DPS Spill" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{e41ace42-2d80-42a0-be24-d1753c072dd2}";;

    RULE                 "Yest_Prj_Div_DPS";
    DESCRIPTION          "Description: This rule calculates the volume of Project diversions that are charged to Deferred Project Supply (DPS).<br>Logic: Project DPS diversion is set equal to yesterday’s Project DPS fraction multiplied by the total of yesterday’s UKL-supplied diversions (Ady, North, A Canal request, and Station 48/Miller Hill) converted from flow to volume over the prior timestep.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "OpsData.Proj DPS Div" [] := $ "OpsData.Proj DPS Fraction" [@"t - 1"] * "FlowToVolume"( ( $ "Ady Canal.DiversionFromUKL" [@"t - 1"] + $ "North Canal.DiversionFromUKL" [@"t - 1"] + $ "A Canal.Diversion Request" [@"t - 1"] + $ "Sta48 and MH from Lost.DiversionFromUKL" [@"t - 1"] ), @"t - 1" );

    END
    UUID "{70e3f112-73e4-49db-8422-e7d32a905e89}";;

    RULE                 "yes_Refuge_Div";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Debits DPSA for DPS valu delivered to refuges that day. Set this to 0 for now. DPS might go to refuge only after theres water to agriculture diversion and its in flood spill state and the daily max value of the canals to refuge have not been fulfilled";
    BEGIN

    INACTIVE      $ "Refuge Policy Tracking.Refuge_DPS_Div" [] := $ "DPS_TLNWR_alloc" [] + $ "DPS_LKNWR_alloc" [];

    INACTIVE      $ "OpsData.Refuge DPS Div" [] := $ "Refuge Policy Tracking.RefugeDailyCap" [@"t"];

    INACTIVE      $ "OpsData.Refuge DPS Div" [] := $ "A Cana.DiversionFromDPS" [];

      $ "OpsData.Refuge DPS Div" [] := 0.00000000 " acre-ft";

    END
    UUID "{5a760d98-ba36-4ce2-82b3-8753b24bd960}";;

    RULE                 "Yesterday's PC Savings";
    DESCRIPTION          "Description: This rule calculates the daily volume of “flow savings” credited to UKL from Project contributions to Keno flow, excluding any portion that is spilling as flood control excess.<br>Logic: From November 1–December 31 and from January 1–September 30, Daily Flow Savings equals the prior day’s Project Contributions to Keno Flows minus the prior day’s Keno excess flow (C13_EXC), floored at zero, and converted from flow to volume for the timestep. Outside these periods, Daily Flow Savings is set to zero.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" >= @"November 1" AND @"t" <= @"December 31") THEN
            $ "Upper Klamath Lake.Daily Flow Savings" [] := "FlowToVolume"( "Max"( 0.00000000 "cfs", $ "Keno data.Project Contributions to Keno Flows" [@"t - 1"] - "c13_exc"( @"t - 1" ) ), @"t" ) COMMENTED_BY "Calculates the volume of water LRDC and F/FF pumps are contributing to Keno flows, minus any <br><br>spilling for flood control <br><br>";

      ELSE
            $ "Upper Klamath Lake.Daily Flow Savings" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" <= @"September 30" )
      ELSEIF_CLAUSE
            $ "Upper Klamath Lake.Daily Flow Savings" [] := "FlowToVolume"( "Max"( 0.00000000 "cfs", $ "Keno data.Project Contributions to Keno Flows" [@"t - 1"] - "c13_exc"( @"t - 1" ) ), @"t" );
      END_ELSEIF;

    END
    UUID "{c5f27a6b-dc92-42e3-956b-4debcd40ef55}";;

    RULE                 "Calculate Project Diversion Fraction";
    DESCRIPTION          "Description :This rule sets the fraction of Project diversions that are charged to the Deferred Project Supply (DPS) account.<br>Logic: The Project DPS fraction is set to 0 from November 1–December 31 and from January 1–February 28. From March 1–October 31, it is calculated as the DPS account balance divided by remaining UKL supply (with a small minimum denominator), and then constrained between 0 and 1.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define credit_use_fraction&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" >= @"November 1" AND @"t" <= @"December 31") THEN
            $ "OpsData.Proj DPS Fraction" [] := 0.00000000;

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Proj DPS Fraction" [] := 0.00000000;
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"March 1" AND @"t" < @"November 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Proj DPS Fraction" [] := "Min"( 1.00000000, "Max"( 0.00000000, $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] / "Max"( 0.10000000 "acre-ft", $ "OpsData.RemUKLSupply" [] ) ) );
      END_ELSEIF;

    END
    UUID "{9bf670ae-e484-4e95-9214-657fe379cbbc}";;

    RULE                 "RemUKLSupply";
    DESCRIPTION          "Description: This rule calculates remaining available UKL supply used for DPS fraction calculations, and forces the value to zero outside the main supply season accounting window.<br>Logic: RemUKLSupply is set to zero during December and from January 1 through March 1. From March 1 through November 30, it is calculated as the prior-day Project Supply balance plus the remaining forecast/estimated supply (UKL projected total minus cumulative supply-season deliveries to date), floored at zero";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define RemUKLSupply_&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" >= @"December 1" AND @"t" <= @"December 31") THEN
            $ "OpsData.RemUKLSupply" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" <= @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.RemUKLSupply" [] := 0.00000000 "acre-ft";
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"March 1" AND @"t" < @"December 1" )
      ELSEIF_CLAUSE
            $ "OpsData.RemUKLSupply" [] := "Max"( 0.00000000 "acre-ft", $ "OpsData.ProjectSupplyAccounting" [@"t - 1"] + ( $ "OpsData.UKL_Prj_Credit_EstTotA" [] - $ "Output.CumAg_ss_DelDV" [@"t - 1"] ) );
      END_ELSEIF;

    END
    UUID "{c6319777-c096-42e5-8051-4fec8f353657}";;

    RULE                 "UKL_Prj_Credit_EstTotA";
    DESCRIPTION          "Description: This rule sets and holds an estimated total UKL Project Credit value for use in seasonal supply accounting, based on the Deferred Project Supply Account.<br>Logic: The value is initialized to zero on October 5, 1980. On March 1 and again on April 1, it is set equal to the current Deferred Project Supply Account balance (floored at zero). On all other days, it simply carries forward the previous day’s value.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define UKL_Prj_Credit_EstTotA&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 5" AND "GetYear"( @"Current Year" ) == 1980.00000000) THEN
            $ "OpsData.UKL_Prj_Credit_EstTotA" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t"] := "Max"( 0.00000000 "acre-ft", $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t"] := $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t"] := "Max"( 0.00000000 "acre-ft", $ "Upper Klamath Lake.Deferred Project Supply Account" [@"t"] );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"April 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t"] := $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t"] := $ "OpsData.UKL_Prj_Credit_EstTotA" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{233c5b9f-8cdb-4c5b-8e4f-3b7e7fb713dd}";;

  END
  UUID "{eca77c8f-e053-4bb1-a912-25ef28bf7a10}";;

  POLICY_GROUP   "Project Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "Calculate Project Supply";
    DESCRIPTION          "Description: This rule sets the Project Supply accounting volume for the year, resets it to zero outside the supply season, and recalculates it at key dates using inflow-based supply plus a storage/supply component, capped at 350,000 acre-ft.<br>Logic: The value is initialized to 220,000 acre-ft on October 1, 1980. It is set to zero from December 1–December 31 and from January 1 through the end of February. On March 1, Project Supply is set to the lesser of 350,000 acre-ft or (Project Supply from Inflow + Project Storage on March 1). From March 2–March 31 it is held constant. From April 1–November 30, it is recalculated as the lesser of 350,000 acre-ft or (Project Supply from Inflow + Firm Project Supply).<br>";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define PrjSupply_PA&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" == @"October 1" AND "GetYear"( @"Current Year" ) == 1980.00000000) THEN
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := 220000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"December 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := 0.00000000 "acre-ft";
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := 0.00000000 "acre-ft";
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := "Min"( 350000.00000000 "acre-ft", $ "OpsData.Project Supply from Inflow_Variable" [@"t"] + $ "OpsData.Project_Storage_Mar1" [@"t"] );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := $ "OpsData.ProjectSupplyAccounting" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"April 1" AND @"t" < @"December 1" )
      ELSEIF_CLAUSE
            $ "OpsData.ProjectSupplyAccounting" [@"t"] := "Min"( 350000.00000000 "acre-ft", $ "OpsData.Project Supply from Inflow_Variable" [@"t"] + $ "OpsData.Firm Project Supply" [@"t"] );
      END_ELSEIF;

    END
    UUID "{b673dfc8-1073-413b-9567-ae2cccb264ac}";;

    RULE                 "Calculate Cumulative Ag Diversion";
    DESCRIPTION          "Description: This rule tracks cumulative Project Supply used during the irrigation season based on canal diversions charged to Project Supply.<br>Logic: From January 1 through February 28, Total Project Supply Used is set to zero. From March 1 through October 31, it accumulates daily by adding the current timestep volumes (converted from flow) of Project Supply diversions for A Canal, Station 48/Miller Hill, Ady Canal, and North Canal. Outside these periods, it carries forward the prior day’s value.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" < @"March 1" AND @"t" >= @"January 1") THEN
            $ "OpsData.TotalProjectSupplyUsed" [] := 0.00000000 "acre-ft";

      ELSE
            $ "OpsData.TotalProjectSupplyUsed" [@"t"] := $ "OpsData.TotalProjectSupplyUsed" [@"t - 1"];

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"March 1" AND @"t" < @"November 1" )
      ELSEIF_CLAUSE
            $ "OpsData.TotalProjectSupplyUsed" [@"t"] := $ "OpsData.TotalProjectSupplyUsed" [@"t - 1"] + "FlowToVolume"( $ "A Canal.DiversionFromProjectSupply" [], @"t" ) + "FlowToVolume"( $ "Sta48 and MH from Lost.DiversionFromProjectSupply" [], @"t" ) + "FlowToVolume"( $ "Ady Canal.DiversionFromProjectSupply" [], @"t" ) + "FlowToVolume"( $ "North Canal.DiversionFromProjectSupply" [], @"t" );
      END_ELSEIF;

    END
    UUID "{44a4afab-8a62-483d-abb3-d4b902dcb9e2}";;

    RULE                 "Variable Project Supply Inflow";
    DESCRIPTION          "Description: This rule calculates and then holds the variable (inflow-based) portion of Project Supply, updating it at key forecast dates (March 1, April 1, April 15, and June 1) based on historic inflow forecasts and the Operations Index, and capping it so total supply does not exceed 350,000 acre-ft.<br>Logic: Before April 1 of water year 1980 (i.e., years before 1981), the variable inflow supply is set to 120,000 acre-ft. From January 1 to February 28 it carries forward. On March 1 it is calculated as a historic forecast value (looked up for the current year) multiplied by a project share factor based on the Ops Index, and then held constant until April 1. On April 1, April 15, and June 1 it is recalculated using the corresponding historic forecast period and the Ops Index project share, adjusted by subtracting the firm inflow supply already counted on April 1, multiplied by Project Supply Multiplier, and limited so that firm supply plus variable supply does not exceed 350,000 acre-ft. Between these update dates, the value is held constant through December 31.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define Project_AprSep_Inflow&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" < @"April 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := 120000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := $ "OpsData.Project Supply from Inflow_Variable" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := "TableInterpolation"( $ "Historical Inflows and NWI.Historic Forecasts", 0.00000000, 2.00000000, "GetYear"( @"24:00:00 April 15, Current Year" ), @"t" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" < @"April 1" AND @"t" > @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := $ "OpsData.Project Supply from Inflow_Variable" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := "Min"( 350000.00000000 "acre-ft" - $ "OpsData.Firm Project Supply" [@"24:00:00 April 1, Current Year"], ( "TableInterpolation"( $ "Historical Inflows and NWI.Historic Forecasts", 0.00000000, 3.00000000, "GetYear"( @"24:00:00 April 15, Current Year" ), @"t" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" ) - $ "OpsData.Project Supply from Inflow_Firm" [@"24:00:00 April 1, Current Year"] ) * $ "OpsData.ProjSuppMult" [] );
      END_ELSEIF
      ELSEIF_COND ( @"t" < @"April 15" AND @"t" > @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := $ "OpsData.Project Supply from Inflow_Variable" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 15" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := "Min"( 350000.00000000 "acre-ft" - $ "OpsData.Firm Project Supply" [@"t"], ( "TableInterpolation"( $ "Historical Inflows and NWI.Historic Forecasts", 0.00000000, 4.00000000, "GetYear"( @"24:00:00 April 15, Current Year" ), @"t" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" ) - $ "OpsData.Project Supply from Inflow_Firm" [@"24:00:00 April 1, Current Year"] ) * $ "OpsData.ProjSuppMult" [] );
      END_ELSEIF
      ELSEIF_COND ( @"t" < @"June 1" AND @"t" > @"April 15" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := $ "OpsData.Project Supply from Inflow_Variable" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"June 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := "Min"( 350000.00000000 "acre-ft" - $ "OpsData.Firm Project Supply" [@"t"], ( "TableInterpolation"( $ "Historical Inflows and NWI.Historic Forecasts", 0.00000000, 5.00000000, "GetYear"( @"24:00:00 April 15, Current Year" ), @"t" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" ) - $ "OpsData.Project Supply from Inflow_Firm" [@"24:00:00 April 1, Current Year"] ) * $ "OpsData.ProjSuppMult" [] );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"June 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Variable" [@"t"] := $ "OpsData.Project Supply from Inflow_Variable" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{4199cb4c-76b3-4a4e-9035-4ea77aa037af}";;

    RULE                 "Calculate Firm Project Supply (Inflow + Storage)";
    DESCRIPTION          "Description: This rule sets the “firm” portion of Project Supply, updating it on April 1 (and again on April 15) based on firm inflow supply plus April 1 storage, and capping firm supply at 350,000 acre-ft.<br>Logic: Before April 1 of water year 1980 (years before 1981), Firm Project Supply is set to 100,000 acre-ft. From January 1 through March 31 it carries forward. On April 1 it is calculated as the lesser of 350,000 acre-ft or (Project Supply from Inflow_Firm + Project Storage on April 1). It is then held constant from April 2–April 14. On April 15 it is recalculated using the same formula, and then held constant for the remainder of the year.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define Project_firm_supply&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" < @"April 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Firm Project Supply" [] := 100000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Firm Project Supply" [@"t"] := $ "OpsData.Firm Project Supply" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Firm Project Supply" [] := "Min"( 350000.00000000 "acre-ft", $ "OpsData.Project Supply from Inflow_Firm" [@"t"] + $ "OpsData.Project_Storage_Apr1" [@"t"] );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"April 2" AND @"t" < @"April 15" )
      ELSEIF_CLAUSE
            $ "OpsData.Firm Project Supply" [@"t"] := $ "OpsData.Firm Project Supply" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 15" )
      ELSEIF_CLAUSE
            $ "OpsData.Firm Project Supply" [] := "Min"( 350000.00000000 "acre-ft", $ "OpsData.Project Supply from Inflow_Firm" [@"t"] + $ "OpsData.Project_Storage_Apr1" [@"t"] );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"April 15" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Firm Project Supply" [@"t"] := $ "OpsData.Firm Project Supply" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{0cba4d73-0d53-4489-b9a8-3563a5afb4e8}";;

    RULE                 "Firm Project Supply From Inflow";
    DESCRIPTION          "Description: This rule calculates the firm inflow-based Project Supply using an April 15 forecast and the Operations Index, then holds it constant after April 15; it also constrains firm inflow supply so total Project Supply does not exceed 350,000 acre-ft when combined with storage supply.<br>Logic: Before April 1 of water year 1980 (years before 1981), firm inflow supply is set to 100,000 acre-ft and carried forward through March 31. From April 1–April 15, it is calculated as the lesser of (350,000 minus Project Supply from Storage on April 1) or (an April 15 95% exceedance historic inflow forecast for the current year multiplied by the project share factor based on the Ops Index). From April 16 through December 31, the value is held constant at the prior day’s value.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "See WRIMS Seasonal_Supply.wresl &quot;define Project_firm_inflow&quot; for wrims reference";
    BEGIN

      IF_STATEMENT (@"t" < @"April 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Project Supply from Inflow_Firm" [] := 100000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Firm" [@"t"] := $ "OpsData.Project Supply from Inflow_Firm" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"April 1" AND @"t" <= @"April 15" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Firm" COMMENTED_BY "Calculates the Firm Project Supply from Inflow between April 1 and 15 through lookup tables  <br><br>" [] := "Min"( 350000.00000000 "acre-ft" - $ "OpsData.Project Supply from Storage" [@"24:00:00 April 1, Current Year"], "TableInterpolation"( $ "Historical Inflows and NWI.Historic Forecasts", 0.00000000, 7.00000000, "GetYear"( @"24:00:00 April 15, Current Year" ), @"t" ) COMMENTED_BY "Looks up the April 15th 95% exceedence forecast by Water Year <br><br>" * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" ) );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"April 16" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Inflow_Firm" COMMENTED_BY "Locks in the Firm project supply from Inflow after April 15th <br><br>" [] := $ "OpsData.Project Supply from Inflow_Firm" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{fe9dfbe6-977b-4ad3-9a86-0e45055ed1d4}";;

    RULE                 "Calculate Project Multiplier";
    DESCRIPTION          "Description: Project Multiplier assigned based on wrims value.";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Need to figure out how to calculate exceedance value<br>";
    BEGIN

      $ "OpsData.ProjSuppMult" [] := 1.50000000;

    END
    UUID "{e616baa5-c479-4b3b-bb4f-5bf0edcb346a}";;

    RULE                 "Firm Project Supply From Storage";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Calculates the firm project supply from storage (PSS) between Jan 1 and April 2. This portion of project supply is locked in on April 1 and the calcualted value is set in the Project Supply slot in UKL.<br><br>first on march 1<br>- 	then april 1: project supply from storage(pss) = (UKL shadow storage (SSd) - 209.111 taf) * Project Share (PS)<br>- Project Supply Storage on April if the firm project supply from storage (does not change again)<br><br><br>what is the value from ss to winter of next year?<br>";
    BEGIN

      IF_STATEMENT (@"t" < @"April 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Project Supply from Storage" [@"t"] := 80000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Storage" [@"t"] := $ "OpsData.Project Supply from Storage" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Storage" [@"t"] := "Max"( 0.00000000 "acre-ft", "ElevationToStorage"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Shadow Elevation" [@"t"] ) - 209111.00000000 "acre-ft" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Storage" [@"t"] := $ "OpsData.Project Supply from Storage" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Storage" [@"t"] := "Max"( 0.00000000 "acre-ft", "ElevationToStorage"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Shadow Elevation" [@"t"] ) - 209111.00000000 "acre-ft" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" >= @"April 2" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Project Supply from Storage" [@"t"] := $ "OpsData.Project Supply from Storage" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{752564a7-b7e9-4d5a-8847-ac39ae688f23}";;

    RULE                 "Project Storage Apr1";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" < @"April 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Project_Storage_Apr1" [@"t"] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Apr1" [@"t"] := $ "OpsData.Project_Storage_Apr1" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"April 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Apr1" [@"t"] := "Max"( 0.00000000 "acre-ft", "ElevationToStorage"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Shadow Elevation" [@"t"] ) - 209111.00000000 "acre-ft" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"April 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Apr1" [@"t"] := $ "OpsData.Project_Storage_Apr1" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{0e7cfeda-7486-40bf-bab3-4d1e5753796e}";;

    RULE                 "Project Storage Mar1";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" < @"March 1" AND "GetYear"( @"Current Year" ) < 1981.00000000) THEN
            $ "OpsData.Project_Storage_Mar1" [@"t"] := 0.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"January 1" AND @"t" < @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Mar1" [@"t"] := $ "OpsData.Project_Storage_Mar1" [@"t - 1"];
      END_ELSEIF
      ELSEIF_COND ( @"t" == @"March 1" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Mar1" [@"t"] := "Max"( 0.00000000 "acre-ft", "ElevationToStorage"( % "Upper Klamath Lake", $ "Upper Klamath Lake.Shadow Elevation" [@"t"] ) - 209111.00000000 "acre-ft" ) * "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );
      END_ELSEIF
      ELSEIF_COND ( @"t" > @"March 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "OpsData.Project_Storage_Mar1" [@"t"] := $ "OpsData.Project_Storage_Mar1" [@"t - 1"];
      END_ELSEIF;

    END
    UUID "{ad398355-38c4-468a-b94d-3262abe33eb5}";;

    RULE                 "ProjectShare";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "OpsData.ProjShare" [] := "TableInterpolation"( $ "OpsData.Project Share Calculator", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], @"t" );

    END
    UUID "{a024f23d-401e-4e03-9e2e-7213093d8cbf}";;

  END
  UUID "{7aea3906-55b4-4a60-a713-f57fd2cc276a}";;

  POLICY_GROUP   "Refuge Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "Refuge Allocation ";
    DESCRIPTION          "Purpose: Cover LKNWR need from Dedicated UKL within today?s allowance.<br>Reads: RefugeDemand.LKNWR, AllowedToday. Optional: Ady capacity if you enforce hydraulics here.<br>Writes: a working allocation variable (e.g., Alloc.LKNWR.UKLded (AF/d)), or write directly to Ady request later.<br>Logic: UseDedicated = min(Need, AllowedToday); Remaining = Need - UseDedicated.<br>Notes: If you track combined deliveries for both refuges, this rule contributes only LKNWRs portion to the combined tally (see Rule 4.1).<br><br>Purpose: If LKNWR still needs water, allow DPS Spill only after Ag diversions are satisfied.<br>Reads: Remaining from Rule 3.2; a DPS Spill availability series for ?after Ag? (e.g., DPS.AfterAg.Available (AF/d)).<br>Writes: working allocation Alloc.LKNWR.DPSspill (AF/d).<br>Logic: If DPS.AfterAg.Available > 0: UseDPS = min(Remaining, DPS.AfterAg.Available); update Remaining.<br>Notes: This rule does not accrue DPSA; its a debit from DPSA (accounted later).";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "need to calculate ukl flood spill avaialbe; ffa accounting, dps after ag<br>we don't pull directly from dps - check logic in wrims to see when water gets pulled from dps<br>pull from flood spill first <br>double check on dps spill<br>";
    BEGIN

      $ "Refuge Policy Tracking.RefugeAllowedToday" [] := "Min"( "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.RefugeCumlativeMax" [] - $ "Refuge Policy Tracking.RefugeCumlativeDelivered" [] ), $ "Refuge Policy Tracking.RefugeDailyCap" [] );

    INACTIVE      $ "Refuge Policy Tracking.FloodSpill_LKNWR_alloc" [] := IF ( $ "Refuge Policy Tracking.DPSA Balance" [] <= 0.00000000 AND $ "UKL.FFA" [] <= 0.00000000 AND $ "UKL.Spill" [] > 0.00000000 )
 THEN
  "Min"( "Max"( 0.00000000, $ "Refuge Policy Tracking.LKNWR_Demand" [] - $ "Refuge Policy Tracking.UKL_LKNWR_alloc" [] ), "Max"( 0.00000000, $ "Refuge Policy Tracking.FloodSpillAvail" [] ) )
 ELSE
  0.00000000
 ENDIF;

    END
    UUID "{9f0e359a-99da-4c4d-ad1b-ed502bc2a98d}";;

    RULE                 "LKNWR Credit";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Calculcates the max inflow needed into LKWNR. Either 250CFS (max deliveries through the canal) or whatever the volume of water needed is to fill the Refuge to capacity. Result is the smaller value.<br><br>TODOS:<br><br>need TLNWR storage volume value and max cfs delivered through station48<br>";
    BEGIN

    INACTIVE      $ "Tule Sumps 1A.needed inflow" [@"t"] := "Min"( 500.00000000 "cfs", "SolveInflow"( % "Tule Sumps 1A", $ "Tule Sumps 1A.Outflow" [@"t - 1"], 33075.22300000 "acre-ft", $ "Tule Sumps 1A.Storage" [@"t - 1"], @"24:00:00 October 5, 1980" ) );

    INACTIVE      $ "LKNWR Cell2.needed inflow" [] := "Min"( 90.00000000 "cfs", "SolveInflow"( % "LKNWR Cell2", $ "LKNWR Cell2.Outflow" [@"t - 1"], 33075.22300000 "acre-ft", $ "LKNWR Cell2.Storage" [@"t - 1"], @"t" ) );

    INACTIVE      $ "LKNWR Cell2.needed inflow" [] := "SolveInflow"( % "LKNWR Cell2", $ "LKNWR Cell2.Outflow" [@"t - 1"], 15.86900000 "acre-ft", $ "LKNWR Cell2.Storage" [@"t - 1"], @"t" );

      $ "Ady To Refuge.LKNWR_Credit" [] := $ "Ady To Refuge.LKNWR_Allocation" [] - $ "Ady To Refuge.Outflow" [];

    END
    UUID "{c95d5f42-074d-47e6-b0eb-d0cc312556d9}";;

    RULE                 "LKNWR Allocations";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

    INACTIVE      IF_STATEMENT (@"t" >= @"March 1" AND @"t" <= @"October 31") THEN
            $ "Ady To Refuge.allocation" [] := $ "Ady To Refuge.allocation" [@"t - 1"] - "FlowToVolume"( $ "Ady To Refuge.Diversion" [], @"t - 1" );

      ELSE
            $ "Ady To Refuge.allocation" [] := 21000.00000000 "acre-ft";

      END_IF_STATEMENT
      ELSEIF_COND ( @"t" >= @"November 1" AND @"t" <= @"December 31" )
      ELSEIF_CLAUSE
            $ "Ady To Refuge.allocation" [] := 0.00000000 "acre-ft";
      END_ELSEIF;

      $ "Ady To Refuge.LKNWR_Allocation" [] := "VolumeToFlow"( $ "Refuge Policy Tracking.LKNWRDailyCap" [], @"t" );

    END
    UUID "{952fc517-813f-4bca-aea5-26efae15ee7a}";;

    RULE                 "Ady To Refuge (LKNWR) Daily Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "how does this work? do i have to set a diversion request value - what about the demand for the refuge<br>";
    BEGIN

      $ "Ady To Refuge.Diversion Request" [@"t"] := $ "LKNWR Cell2.Outflow" [@"t - 1"];

    END
    UUID "{6474cc6a-817c-484b-81ca-dbe1c796fd27}";;

    RULE                 "Sta48 and MH Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Sta48 and MH from Lost.Diversion Request" [] := $ "Sta48 and MH from Lost.To_Project" [] + $ "Sta 48 to TLNWR.Diversion Request" [];

    END
    UUID "{9ff47d01-0d12-4afc-a350-84b76b7fdb88}";;

    RULE                 "Sta 48 to TLNWR Daily Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Tule Sumps 1A.Outflow" [@"t - 1"] >= $ "Wilson Dam to Tule.Outflow" [@"t - 1"]) THEN
            $ "Sta 48 to TLNWR.Diversion Request" [@"t"] := $ "Tule Sumps 1A.Outflow" [@"t - 1"] - $ "Wilson Dam to Tule.Outflow" [@"t - 1"];

      ELSE
            $ "Sta 48 to TLNWR.Diversion Request" [@"t"] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{a1a4feff-dda4-4473-afa7-c0c44967cb83}";;

    RULE                 "Refuge Cumulative Delivered";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Refuge Policy Tracking.RefugeCumlativeDelivered" [] := $ "Refuge Policy Tracking.LKNWRCumulativeDelivered" [] + $ "Refuge Policy Tracking.TLNWRCumulativeDelivered" [];

    END
    UUID "{244f26de-0b02-4c07-a8c3-49184659ea35}";;

    RULE                 "Calculate Cumulative Delivery";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Refuge Policy Tracking.LKNWRCumulativeDelivered" [] := "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.LKNWRCumulativeDelivered" [@"t - 1"] + "FlowToVolume"( $ "LKNWR Cell2.Inflow" [], @"t" ) );

      $ "Refuge Policy Tracking.TLNWRCumulativeDelivered" [] := "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.TLNWRCumulativeDelivered" [@"t - 1"] + "FlowToVolume"( $ "Tule Lake NWR.Inflow" [], @"t" ) );

    END
    UUID "{8515a522-e449-42a9-8c8e-02065e3a50fb}";;

    RULE                 "Calculate Evaporation (Outflow)";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Not working for some reason. Temprary code in Inflow test. <br><br>This is monthly evaporation rate - need to divide by number of days<br>";
    BEGIN

      $ "LKNWR Cell2.Outflow" [@"t"] := $ "LKNWR Cell2.DailyEvaporation" [@"t"] * 1.00000000 "day";

      $ "Tule Sumps 1A.Outflow" [@"t"] := $ "Tule Sumps 1A.DailyEvaporation" [@"t"] * 1.00000000 "day";

    END
    UUID "{6b245964-61bc-47c7-962e-12a9a0af03f9}";;

    RULE                 "Daily LKNWR Evaporation";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "LKNWR Cell2.DailyEvaporation" [] := "VolumeToFlow"( $ "LKNWR Cell2.Area" [] * $ "LKNWR Cell2.Evap" [@"t"], @"t - 1" ) / "LKNWR Cell2.days_in_month" [];

    END
    UUID "{d7ca42e4-a4c3-4885-b705-9b10c4c1bb0a}";;

    RULE                 "Daily Tule Sumps Evaporation";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Tule Sumps 1A.DailyEvaporation" [] := "VolumeToFlow"( $ "Tule Sumps 1A.Area" [] * $ "Tule Sumps 1A.Evap" [@"t"], @"t - 1" ) / "Tule Sumps 1A.days_in_month" [];

    END
    UUID "{b7bdb208-20e3-4dd2-afe3-52df911ed244}";;

    RULE                 "get days in month";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      "LKNWR Cell2.days_in_month" [] := "GetDaysInMonth"( @"t" );

      "Tule Sumps 1A.days_in_month" [] := "GetDaysInMonth"( @"t" );

    END
    UUID "{2c1bcd97-507c-440a-81bb-3fc0a1835576}";;

    RULE                 "Calculate LKNWR Area";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "LKNWR Cell2.Area" [] := "TableInterpolation"( $ "LKNWR Cell2.Elevation Area", 0.00000000, 1.00000000, $ "LKNWR Cell2.Pool Elevation" [], @"t - 1" );

    END
    UUID "{49303f26-8933-4721-bdce-6c6fea43efb6}";;

    RULE                 "Calculate Tule Sumps Area";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Tule Sumps 1A.Area" [] := "TableInterpolation"( $ "Tule Sumps 1A.Elevation Area", 0.00000000, 1.00000000, $ "Tule Sumps 1A.Pool Elevation" [], @"t - 1" );

    END
    UUID "{7d51ea1f-c576-41ee-a50e-ec72968f3c49}";;

    RULE                 "Set Refuge Diversion Value";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

    INACTIVE      "LKNWR Cell2.Outflow" [] := 20.00000000 "cfs";

      $ "LKNWR Cell2.Diversion" [] := 0.00000000 "cfs";

      $ "Tule Sumps 1A.Diversion" [] := 0.00000000 "cfs";

    END
    UUID "{8f1d349f-9915-4495-8c14-195cb6d475b7}";;

  END
  UUID "{1fb26019-b006-4221-9451-4a9c4fe29364}";;

  POLICY_GROUP   "Seasonal State";
  DESCRIPTION    "Purpose: Enforce  can t deliver faster than uniform rate  and the 43,000 AF seasonal cap (combined refuges).<br>Reads: Date (month/day).<br>Writes: DedicatedRefuge.DailyCap (AF/d), DedicatedRefuge.CumMax (AF).<br>Logic:<br><br>If Apr Oct: DailyCap = 43,000 / 214   200.9346 AF/d.<br><br>CumMax = min(43,000, days_since_Apr1_inclusive   DailyCap).<br><br>Else (Nov Mar): set both to 0.<br>Notes: This rule doesn t deliver water; it just prepares the cap curve for today";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "TLNWR Seasonal Cumulative Max";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" >= @"April 1" AND @"t" < @"November 1") THEN
            $ "Refuge Policy Tracking.TLNWRCumulativeMax" [] := "Min"( 21000.00000000 "acre-ft", "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.TLNWRCumulativeMax" [@"t - 1"] + $ "Refuge Policy Tracking.TLNWRDailyCap" [] ) );

      ELSE
            $ "Refuge Policy Tracking.TLNWRCumulativeMax" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{55e99f2f-55e3-4bf2-b2ab-822b01a006ae}";;

    RULE                 "TLNWR Seasonal Daily Cap";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" > @"April 1" AND @"t" < @"October 1") THEN
            $ "Refuge Policy Tracking.TLNWRDailyCap" [] := 22000.00000000 "acre-ft" / 213.00000000;

      ELSE
            $ "Refuge Policy Tracking.TLNWRDailyCap" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{30403ce4-1d47-41b8-92a4-e77abfe35dc5}";;

    RULE                 "LKNWR Seaonsal Cumulative Max";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

    INACTIVE      $ "Refuge Policy Tracking.LKNWRCumulativeMax" [] := "Min"( 21000.00000000 "acre-ft", "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.LKNWRCumulativeMax" [@"t - 1"] + $ "Refuge Policy Tracking.LKNWRDailyCap" [] ) );

      IF_STATEMENT (@"t" >= @"April 1" AND @"t" < @"November 1") THEN
            $ "Refuge Policy Tracking.LKNWRCumulativeMax" [] := "Min"( 21000.00000000 "acre-ft", "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.LKNWRCumulativeMax" [@"t - 1"] + $ "Refuge Policy Tracking.LKNWRDailyCap" [] ) );

      ELSE
            $ "Refuge Policy Tracking.LKNWRCumulativeMax" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{277512f6-e132-4944-b759-dddd9a6df677}";;

    RULE                 "LKNWR Seasonal Daily Cap";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT (@"t" > @"April 1" AND @"t" < @"October 1") THEN
            $ "Refuge Policy Tracking.LKNWRDailyCap" [] := 21000.00000000 "acre-ft" / 213.00000000;

      ELSE
            $ "Refuge Policy Tracking.LKNWRDailyCap" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{f42f673b-6c28-4ea6-896b-49b92fdfb99d}";;

    RULE                 "Set Cumulative Max";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

    INACTIVE      $ "Refuge Policy Tracking.RefugeCumlativeMax" [] := "Min"( 43000.00000000 "acre-ft", "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.RefugeCumlativeMax" [@"t - 1"] + $ "Refuge Policy Tracking.RefugeDailyCap" [] ) );

      IF_STATEMENT (@"t" >= @"April 1" AND @"t" < @"November 1") THEN
            $ "Refuge Policy Tracking.RefugeCumlativeMax" [] := "Min"( 43000.00000000 "acre-ft", "Max"( 0.00000000 "acre-ft", $ "Refuge Policy Tracking.RefugeCumlativeMax" [@"t - 1"] + $ "Refuge Policy Tracking.RefugeDailyCap" [] ) );

      ELSE
            $ "Refuge Policy Tracking.RefugeCumlativeMax" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{33c0720f-595d-4ffd-af19-3ae354e38989}";;

    RULE                 "Set Refuge Seasonal Daily Cap";
    DESCRIPTION          "Purpose: Enforce  can t deliver faster than uniform rate  and the 43,000 AF seasonal cap (combined refuges).<br>Reads: Date (month/day).<br>Writes: DedicatedRefuge.DailyCap (AF/d), DedicatedRefuge.CumMax (AF).<br>Logic:<br><br>If Apr Oct: DailyCap = 43,000 / 214   200.9346 AF/d.<br><br>CumMax = min(43,000, days_since_Apr1_inclusive   DailyCap).<br><br>Else (Nov Mar): set both to 0.<br>Notes: This rule doesn t deliver water; it just prepares the cap curve for today";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Need to add else<br><br>modify daily cap <br>bioop limitation vs infrastructure limitation";
    BEGIN

      IF_STATEMENT ("SpringSummerAgSeason"( @"t" )) THEN
            $ "Refuge Policy Tracking.RefugeDailyCap" [] := 43000.00000000 "acre-ft" / 213.00000000;

      ELSE
            $ "Refuge Policy Tracking.RefugeDailyCap" [] := 0.00000000 "acre-ft";

      END_IF_STATEMENT;

    END
    UUID "{b7da981c-9b12-4245-908e-e87b39e6f6a9}";;

    RULE                 "Mirror Spill Status";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Refuge Policy Tracking.IsUKLSpilling" [] := IF ( $ "Upper Klamath Lake.Spill" [] > 0.00000000 "cfs" )
 THEN
  1.00000000
 ELSE
  0.00000000
 ENDIF;

      $ "Refuge Policy Tracking.IsKenoSpilling" [] := IF ( $ "Keno.Spill" [] > 0.00000000 "cfs" )
 THEN
  1.00000000
 ELSE
  0.00000000
 ENDIF;

    END
    UUID "{9649acb1-e84e-41bd-8f12-fe433c8207ae}";;

  END
  UUID "{dccd9964-e18a-4e17-8082-98622ece0878}";;

  POLICY_GROUP   "Various Slot-setting Rules";
  DESCRIPTION    "";
  ACTIVE         TRUE;
  NOTES          "";
  BEGIN

    RULE                 "D1 to Sump1A";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "D1 to Sump1A.Diversion Request" [] := $ "Historical Diversions.D1_S1TOSUMP1A" [];

      $ "D1 to Sump1A.Available For Diversion" [] := 4000.00000000 "cfs";

    END
    UUID "{a54c198c-ae22-4ea7-adcb-0402bc280c73}";;

    RULE                 "Keno Accretion Positive";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Keno data.KenoAccretions" [@"t"] > 0.00000000 "cfs") THEN
            $ "Keno Accretion Positive.Local Inflow" [@"t"] := $ "Keno data.KenoAccretions" [@"t"];

      ELSE
            $ "Keno Accretion Positive.Local Inflow" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{03d28316-3d6d-4f95-85d9-ff56083a6998}";;

    RULE                 "Keno Accretion Diversion";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      IF_STATEMENT ($ "Keno data.KenoAccretions" [] < 0.00000000 "cfs") THEN
            $ "Keno Accretion Diversion.Diversion Request" [] := "Abs"( $ "Keno data.KenoAccretions" [] );

      ELSE
            $ "Keno Accretion Diversion.Diversion Request" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{25f0d2d6-0433-41c8-b5df-b5f5e3c04ef2}";;

    RULE                 "Project Contributions to Keno Flows";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "calculates the Project contributions to the Keno flow target and also the keno accretions (positive and negative)<br>";
    BEGIN

      $ "Keno data.Project Contributions to Keno Flows" [] := $ "LRDC into Link.Return Flow" [] + $ "Keno.Flow FROM Pumped Storage" [];

    END
    UUID "{245cc88b-bcfa-4406-84c5-6d2336e2f952}";;

    RULE                 "Diversion to Keno Avaiable For Diversion";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Diversion To Keno Accretion.Available For Diversion" [] := 4000.00000000 "cfs";

    INACTIVE      $ "Keno Accretion Positive.Available For Diversion" [] := 1000.00000000 "cfs";

    END
    UUID "{02ecfe53-ef59-4285-9c40-9b1ea922837d}";;

    RULE                 "Diversion and Multi outflow test";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "this rule sets the diversion request for the Link into LRDC diversion object. Formula is check to see if there is adequate flow from the east side, and if not, divert additional water from the Keno impoundment into the LRDC.";
    BEGIN

      IF_STATEMENT (@"t" >= @"March 1" AND @"t" <= @"November 30" AND $ "Lost into Wilson.Outflow" [] < $ "Wilson Dam to Tule.Diversion Request" [] + $ "Sta48 and MH from Lost.Diversion Request" []) THEN
            $ "Div To LRDC.Multi Outflow" [] := $ "Wilson Dam to Tule.Diversion Request" [] + $ "Sta48 and MH from Lost.Diversion Request" [] - $ "Lost into Wilson.Outflow" [];

      ELSE
            $ "Div To LRDC.Multi Outflow" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{9562f51c-15a5-4948-91ad-8ffe941bca1f}";;

    RULE                 "c13_exc Rule";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Keno.C13_exc" [] := "Max"( 0.00000000 "cfs", "c13_exc"( @"t" ) );

    END
    UUID "{03d1b01a-6515-40ee-ad03-e9999310f304}";;

    RULE                 "c1_exc Rule";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Upper Klamath Lake.c1_exc" [] := "Max"( 0.00000000 "cfs", "C1_exc"( @"t" ) );

    END
    UUID "{6d3529d4-749c-45c7-a361-bb7fc7037adc}";;

    RULE                 "Assigning A Canal Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Need to figure out what starting pool elevation would be. need to verify";
    BEGIN

      $ "A Canal.Diversion Request" [] := $ "Historical Diversions.A canal" [];

      IF_STATEMENT ("SpringSummerAgSeason"( @"t" )) THEN
            $ "A Canal.Diversion Request" [] := $ "Historical Diversions.A canal" [];

      ELSE
            $ "A Canal.Diversion Request" [] := 0.00000000 "cfs";

      END_IF_STATEMENT;

    END
    UUID "{bf6e16bd-f017-46ce-bab1-732e13be0331}";;

    RULE                 "Assigning Historical Values";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Lost into Wilson.Inflow" [] := $ "Historical Inflows and NWI.LRDC Into Wilson" [];

      $ "F_FF pumps.Inflow" [] := $ "Historical Inflows and NWI.F_FF Pumping" [];

      $ "Keno.Accretions" [] := $ "Historical Inflows and NWI.Keno Accretions" [];

    END
    UUID "{befea494-e453-4a8d-a263-82a115ff5766}";;

    RULE                 "Wilson Dam to  Tule Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Wilson Dam to Tule.Diversion Request" [] := $ "Historical Diversions.Wilson Reservoir to Tule Sumps" [];

    END
    UUID "{4416005c-f1f7-4c89-b635-d238966b7694}";;

    RULE                 "Ady Canal Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Ady Canal.Diversion Request" [] := $ "Historical Diversions.Ady Canal to Project" [] + $ "Historical Diversions.Ady Canal to Refuge" [];

    END
    UUID "{6afe5415-d591-4bb7-8b1b-6ca09b785920}";;

    RULE                 "Ady Canal to Project";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Ady Canal.To Project" [] := $ "Historical Diversions.Ady Canal to Project" [];

      $ "Ady Canal.ToRefuge" [] := $ "Historical Diversions.Ady Canal to Refuge" [];

    END
    UUID "{189738c8-f9b6-40fc-bb92-845db44c6ecd}";;

    RULE                 "North Canal Diversion Request";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "North Canal.Diversion Request" [] := $ "Historical Diversions.North Canal FW" [] + $ "Historical Diversions.North Canal SS" [];

    END
    UUID "{22380ef0-ca40-4560-b2df-ceb7fa3f07df}";;

    RULE                 "Sta48 and MH To Project";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "";
    BEGIN

      $ "Sta48 and MH from Lost.To_Project" [] := $ "Historical Diversions.Sta 48 and Miller Hill Year Round" [];

    END
    UUID "{59e67823-7f0c-49d2-bfa6-5a3fd68a5f70}";;

    RULE                 "Diversion and return flow slot setting";
    DESCRIPTION          "";
    ACTIVE               TRUE;
    RULE_EXEC_CONSTRAINT TRUE;
    NOTES                "Rule is set to avoide the error:<br><br><br><br>Must input maximum value for &quot;Available For Diversion&quot;when solving for inflow on reaches<br>";
    BEGIN

      $ "LRDC Draw From Klamath.Available For Diversion" [] := 5000.00000000 "cfs";

      $ "Diversion To Ady.Available For Diversion" [] := 400.00000000 "cfs";

      $ "Diversion To North.Available For Diversion" [] := 190.00000000 "cfs";

      $ "A Canal.Available For Diversion" [] := 1100.00000000 "cfs";

      $ "Ady To Refuge.Available For Diversion" [] := 250.00000000 "cfs";

    INACTIVE      $ "Diversion To Keno Accretion.Available For Diversion" [] := 4000.00000000 "cfs";

    END
    UUID "{f2c8384b-df12-4738-8af1-82e74cc5b775}";;

  END
  UUID "{404a4aed-c375-4776-bbb7-e0f16190069d}";;

  UTILITY_GROUP "Index and counters Group";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "Flood Season" (  )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "Sets Period of time when flood control is operation";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      @"t" > @"November 15" AND @"t" < @"June 15";

    END
    UUID "{c461a803-3da0-4c6e-b629-c590dd385925}";;

    FUNCTION       "KenoReleaseMultiplier" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "Formula only calculates the Keno release multiplier (KRmult) for the current timestep (@&quot;t&quot;).  It does this by interpolating the Keno releast multiplier table in the OpsData data object. <br><br>Keno Release multiplier table is found in Appendix E, pg 23";
    BEGIN

      "TableInterpolation"( $ "Keno.Keno Release Multiplier", 0.00000000, "GetMonth"( date ), $ "OpsData.OpsIndex" [], date );

    END
    UUID "{6aa179b7-482b-429f-85d7-3537b3f5f687}";;

    FUNCTION       "SpringSummerAgSeason" ( DATETIME CurrentDate )
    RETURN_TYPE    BOOLEAN;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "";
    BEGIN

      CurrentDate >= @"24:00:00 April 1, Current Year" AND CurrentDate <= @"24:00:00 October 31, Current Year";

    END
    UUID "{2a98206d-4fbb-4a49-b646-fc6afe922506}";;

    FUNCTION       "Date Counter" ( DATETIME date1, DATETIME date2 )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "Counts the number of days between two dates. Date 1 is the first date, date 2 is the second date ( after).";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "Due to RPL language, the values come out as negative, so the abs function is required. Also, riverware count the difference in seconds, thus the divided by 86400 (# of seconds in a day)";
    BEGIN

      "Abs"( "DateToNumber"( date1 ) - "DateToNumber"( date2 ) ) / 86400.00000000;

    END
    UUID "{9da1bcc1-ac2b-4750-8599-2a03e354313a}";;

  END
  UUID "{414cbb03-700e-40c0-91db-e650864fbb3a}";;

  UTILITY_GROUP "Flexible Flow Account and Project Supply";
  DESCRIPTION   "";
  ACTIVE        TRUE;
  NOTES          "";
  BEGIN

    FUNCTION       "FFA reserve Lookup" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "Looks up the the FFA reserve volume from the table, based on Ops index value.  FFA reserve table is <br>";
    BEGIN

      "TableInterpolation"( $ "OpsData.FFA Reserve table", 0.00000000, 1.00000000, $ "OpsData.OpsIndex" [], date );

    END
    UUID "{a0c6eff5-d9cf-4ec1-a1c0-68a593b63a8e}";;

    FUNCTION       "FFA increment" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "Calculates FFA daily increment based on ops index. <br>Formula #6 from Appendix E (pg 22).<br>See WRIMS UKLSeasonalSupply.wresl &quot;define FFA_inc&quot; for wrims reference<br>";
    BEGIN

      $ "Keno data.River Base Flow" [date] * "KenoReleaseMultiplier"( date ) * "FFA reserve Lookup"( date );

    END
    UUID "{f7fda56f-862b-4d15-8210-c7f7c29ce0ec}";;

    FUNCTION       "Yesterday's FFA Saving" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "Description This function calculates the prior day’s FFA savings volume, after accounting for spill and other flow components, and prevents negative savings.<br>Logic Yesterday’s FFA savings is the positive part of: yesterday’s FFA increment converted to volume, minus the positive portion of yesterday’s “excess” flow remaining after subtracting DPS spill, LRDC return flow, pumped storage contribution, and the Keno ramping flow (all converted to volume). If this result is negative, it is set to zero.";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "See WRIMS UKLSeasonalSupply.wresl &quot;define Yest_FFA_Savings&quot; for wrims reference<br><br>";
    BEGIN

      "Max"( 0.00000000 "acre-ft", "FlowToVolume"( $ "OpsData.FFAInc" [date - 1.00000000 "day"], @"t" ) - "Max"( "FlowToVolume"( "c13_exc"( date - 1.00000000 "day" ) - $ "LakeData.DPS Spill" [date] - $ "LRDC into Link.Return Flow" [date - 1.00000000 "day"] - $ "Keno.Flow FROM Pumped Storage" [date - 1.00000000 "day"] - $ "Keno.RampFlow" [date - 1.00000000 "day"], @"t - 1" ), 0.00000000 "acre-ft" ) );

    END
    UUID "{1e9d8509-bf3e-4c0f-aecf-3b5262c79c2e}";;

    FUNCTION       "C1_exc" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "Formula to calculate C1-exc variable. UKL releases in excess of Minimum flows (typicall occurs during flood control)";
    BEGIN

      $ "Upper Klamath Lake.Outflow" [date] - $ "Upper Klamath Lake.Min Flows" [date];

    END
    UUID "{d1385b40-ac9a-46ff-a7f4-a505d74d7353}";;

    FUNCTION       "c13_exc" ( DATETIME date )
    RETURN_TYPE    NUMERIC;
    SCALE_UNITS    "";
    DESCRIPTION    "";
    ACTIVE         TRUE;
    PRE_EXEC_DIAG  FALSE;
    POST_EXEC_DIAG FALSE;
    NOTES          "<br><br>";
    BEGIN

      $ "Keno.Outflow" [date] - "Max"( $ "Keno data.River Base Flow" [date], $ "Keno.Outflow" [date - 1.00000000 "day"] - $ "Keno.Ramp Down Rate" [date] );

    END
    UUID "{ccd8dd20-c8c6-4232-901a-448732d469e7}";;

  END
  UUID "{7e982052-c8f8-4af9-a346-8cf2e95e341d}";;

END
UUID "{15b62caf-0072-4024-b631-0a4acaa0034b}";
